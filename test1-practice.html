<!DOCTYPE html>
<html lang="zh-CN" translate="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google" content="notranslate">
    <title>Test 1 Practice - All Characters</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5/dist/hanzi-writer.min.js"></script>
    <link rel="stylesheet" href="css/common.css">
    <script src="js/utils.js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8">
    <a href="home.html" class="fixed top-4 left-4 bg-white hover:bg-gray-100 text-gray-700 px-3 py-2 rounded-lg shadow border border-gray-200 transition text-sm">‚Üê Home</a>

    <div class="max-w-3xl mx-auto bg-white rounded-xl shadow-lg p-6 md:p-8 mt-16 md:mt-0">
        <h1 class="text-3xl font-bold text-center mb-6 text-gray-800">Test 1 Practice</h1>

        <!-- Mode Selector -->
        <div class="flex flex-wrap gap-2 justify-center mb-6">
            <button class="mode-btn px-4 py-2 rounded-lg border-2 border-gray-300 hover:bg-gray-100 transition active:bg-blue-500 active:text-white active:border-blue-500" data-mode="char-to-pinyin">Char ‚Üí Pinyin</button>
                <button class="mode-btn px-3 py-2 rounded-lg border-2 border-gray-300 hover:bg-gray-100 transition text-left text-sm" data-mode="char-to-pinyin-type">Char ‚Üí Pinyin (MC)</button>
                <button class="mode-btn px-3 py-2 rounded-lg border-2 border-gray-300 hover:bg-gray-100 transition text-left text-sm" data-mode="char-to-pinyin-tones-mc">Char ‚Üí Pinyin (Tones MC)</button>
            <button class="mode-btn px-4 py-2 rounded-lg border-2 border-gray-300 hover:bg-gray-100 transition" data-mode="audio-to-pinyin">Audio ‚Üí Pinyin</button>
            <button class="mode-btn px-4 py-2 rounded-lg border-2 border-gray-300 hover:bg-gray-100 transition" data-mode="pinyin-to-char">Pinyin ‚Üí Char</button>
            <button class="mode-btn px-4 py-2 rounded-lg border-2 border-gray-300 hover:bg-gray-100 transition" data-mode="char-to-meaning-type">Char ‚Üí Meaning</button>
            <button class="mode-btn px-4 py-2 rounded-lg border-2 border-gray-300 hover:bg-gray-100 transition" data-mode="audio-to-meaning">Audio ‚Üí Meaning</button>
            <button class="mode-btn px-4 py-2 rounded-lg border-2 border-gray-300 hover:bg-gray-100 transition" data-mode="meaning-to-char">Meaning ‚Üí Char</button>
                <button class="mode-btn" data-mode="blend">üîÄ Blend</button>
            <button class="mode-btn px-4 py-2 rounded-lg border-2 border-gray-300 hover:bg-gray-100 transition" data-mode="stroke-order">Stroke Order</button>
            <button class="mode-btn px-4 py-2 rounded-lg border-2 border-gray-300 hover:bg-gray-100 transition" data-mode="handwriting">Handwriting</button>
            <button class="mode-btn px-4 py-2 rounded-lg border-2 border-gray-300 hover:bg-gray-100 transition" data-mode="draw-char">Draw Character</button>
        </div>

        <!-- Question Display -->
        <div id="questionDisplay" class="text-center"></div>

        <!-- Hint -->
        <div id="hint" class="text-center text-sm my-4"></div>

        <!-- Audio Section -->
        <div id="audioSection" class="text-center my-4 hidden">
            <button id="playAudioBtn" class="bg-cyan-500 hover:bg-cyan-600 text-white px-6 py-3 rounded-lg transition">üîä Play Sound</button>
        </div>

        <!-- Type Mode -->
        <div id="typeMode" class="space-y-4">
            <input type="text" id="answerInput" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none text-lg" placeholder="Type your answer...">
            <button id="checkBtn" class="w-full bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg font-semibold transition">Check Answer</button>
        </div>

        <!-- Choice Mode -->
        <div id="choiceMode" class="hidden">
            <div id="options" class="grid grid-cols-2 gap-3"></div>
        </div>

        <!-- Fuzzy Mode -->
        <div id="fuzzyMode" class="hidden space-y-4">
            <input type="text" id="fuzzyInput" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none text-lg" placeholder="Type your answer...">
            <div id="fuzzyOptions" class="grid grid-cols-2 gap-3"></div>
        </div>

        <!-- Stroke Order Mode -->
        <div id="strokeOrderMode" class="hidden">
            <div id="strokeOrderWriter" class="flex justify-center my-8"></div>
        </div>

        <!-- Handwriting Mode -->
        <div id="handwritingMode" class="hidden">
            <div class="text-center text-gray-600 mb-4">Practice writing on paper, then reveal the answer</div>
            <div id="handwritingWriter" class="flex justify-center my-8"></div>
            <div class="flex justify-center gap-3">
                <button id="hwShowBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-8 py-3 rounded-lg transition text-lg">Show Answer</button>
                <button id="hwNextBtn" class="bg-green-500 hover:bg-green-600 text-white px-8 py-3 rounded-lg transition text-lg">Next</button>
            </div>
                            <p id="hwSpaceHint" class="text-center text-sm text-gray-500 mt-2">Space: show ‚Üí tap ‚úì correct ¬∑ hold ‚úó wrong</p>
                </div>

        <!-- Draw Character Mode -->
        <div id="drawCharMode" class="hidden">
            <div class="text-center mb-4">
                <div id="ocrResult" class="text-6xl min-h-[80px] text-blue-600 font-bold"></div>
                <div class="text-sm text-gray-500">Real-time recognition</div>
            </div>
            <canvas id="drawCanvas" class="border-2 border-gray-300 rounded-lg mx-auto cursor-crosshair" width="300" height="300"></canvas>
            <div class="flex gap-3 justify-center mt-4">
                <button id="clearCanvasBtn" class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg transition">üóëÔ∏è Clear</button>
                <button id="submitDrawBtn" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg transition">‚úì Submit</button>
            </div>
        </div>

        <!-- Feedback -->
        <div id="feedback" class="text-center font-semibold my-4 min-h-[24px]"></div>

        <!-- Stats -->
        <div class="flex justify-between text-sm text-gray-600 pt-4 border-t border-gray-200">
            <span>Score: <span id="score" class="font-semibold">0</span>/<span id="total" class="font-semibold">0</span></span>
            <span>Accuracy: <span id="accuracy" class="font-semibold">0%</span></span>
        </div>
    </div>

    <script>
        const characters = [
            // Basic radicals (Character Sheet 1-3)
            { char: 'Êó•', pinyin: 'r√¨', meaning: 'sun/day' },
            { char: 'Êúà', pinyin: 'yu√®', meaning: 'moon/month' },
            { char: 'Ê∞¥', pinyin: 'shu«ê', meaning: 'water' },
            { char: 'ÁÅ´', pinyin: 'hu«í', meaning: 'fire' },
            { char: 'Â±±', pinyin: 'shƒÅn', meaning: 'mountain' },
            { char: '‰∫∫', pinyin: 'r√©n', meaning: 'person' },
            { char: 'Áî∞', pinyin: 'ti√°n', meaning: 'field' },
            { char: 'ÂàÄ', pinyin: 'dƒÅo', meaning: 'knife' },
            { char: 'Êú®', pinyin: 'm√π', meaning: 'wood/tree' },
            { char: 'Á´π', pinyin: 'zh√∫', meaning: 'bamboo' },
            { char: 'Â§ß', pinyin: 'd√†', meaning: 'big' },
            { char: 'Â∞è', pinyin: 'xi«éo', meaning: 'small' },
            { char: 'Â•≥', pinyin: 'n«ö', meaning: 'woman' },
            { char: 'Â≠ê', pinyin: 'z«ê', meaning: 'child' },
            { char: 'Êâã', pinyin: 'sh«íu', meaning: 'hand' },
            { char: 'ÁõÆ', pinyin: 'm√π', meaning: 'eye' },
            { char: 'Âè£', pinyin: 'k«íu', meaning: 'mouth' },
            { char: 'ÂøÉ', pinyin: 'xƒ´n', meaning: 'heart' },
            { char: 'Ë∂≥', pinyin: 'z√∫', meaning: 'foot' },
            { char: 'Ë¥ù', pinyin: 'b√®i', meaning: 'shell/money' },

            // Character Sheet 4B - Radicals
            { char: 'Èáë', pinyin: 'jƒ´n', meaning: 'metal/gold (ÈíÖ)' },
            { char: 'Ë®Ä', pinyin: 'y√°n', meaning: 'speech (ËÆ†)' },
            { char: 'ÂÆù', pinyin: 'b«éo', meaning: 'treasure (ÂÆÄ)' },
            { char: 'Ë∂≥', pinyin: 'z√∫', meaning: 'foot (‚ªä)' },
            { char: 'Á´π', pinyin: 'zh√∫', meaning: 'bamboo (‚∫Æ)' },
            { char: '‰∏ù', pinyin: 'sƒ´', meaning: 'silk (Á∫ü)' },
            { char: 'È£ü', pinyin: 'sh√≠', meaning: 'food (È•£)' },
            { char: 'Á¶æ', pinyin: 'h√©', meaning: 'grain' },
            { char: 'Áä¨', pinyin: 'qu«én', meaning: 'dog (Áä≠)' },
            { char: 'Ëµ∞', pinyin: 'z«íu', meaning: 'walk (Ëæ∂)' },
            { char: 'È©¨', pinyin: 'm«é', meaning: 'horse' },
            { char: 'Èöπ', pinyin: 'zhuƒ´', meaning: 'bird' },
            { char: '‰∏≠', pinyin: 'zh≈çng', meaning: 'middle' },
            { char: 'ËâÆ', pinyin: 'gƒõn', meaning: 'stopping' },
            { char: 'Èùí', pinyin: 'qƒ´ng', meaning: 'green/blue' },
            { char: 'Âè§', pinyin: 'g«î', meaning: 'ancient' },
            { char: 'Â∑¥', pinyin: 'bƒÅ', meaning: 'cling to' },
            { char: 'Ê≠£', pinyin: 'zh√®ng', meaning: 'correct' },
            { char: 'Èïø', pinyin: 'ch√°ng/zh«éng', meaning: 'long/grow' },
            { char: 'Èó®', pinyin: 'm√©n', meaning: 'door' },

            // Phonetic symbols - È©¨ (m«é) group
            { char: 'Â¶à', pinyin: 'mƒÅ', meaning: 'mother' },
            { char: 'Êé®', pinyin: 'tuƒ´', meaning: 'push' },
            { char: 'Ë∞Å', pinyin: 'shu√≠', meaning: 'who' },
            { char: 'Ê∑Æ', pinyin: 'hu√°i', meaning: 'Huai river' },

            // Phonetic symbols - ‰∏≠ (zh≈çng) group
            { char: 'Èíü', pinyin: 'zh≈çng', meaning: 'clock' },
            { char: 'Áßç', pinyin: 'zh«íng/zh√≤ng', meaning: 'kind/plant' },
            { char: '‰ª≤', pinyin: 'zh√≤ng', meaning: 'second (in order)' },
            { char: 'ËÇø', pinyin: 'zh«íng', meaning: 'swollen' },

            // Phonetic symbols - ËâÆ (gƒõn) group
            { char: 'Ë∑ü', pinyin: 'gƒìn', meaning: 'follow/heel' },
            { char: 'Ê†π', pinyin: 'gƒìn', meaning: 'root' },
            { char: 'Áã†', pinyin: 'hƒõn', meaning: 'fierce' },
            { char: 'ÊÅ®', pinyin: 'h√®n', meaning: 'hate' },

            // Phonetic symbols - Èùí (qƒ´ng) group
            { char: 'ËØ∑', pinyin: 'q«êng', meaning: 'please/invite' },
            { char: 'Ê∏Ö', pinyin: 'qƒ´ng', meaning: 'clear' },
            { char: 'ÊÉÖ', pinyin: 'q√≠ng', meaning: 'emotion' },
            { char: 'Êô¥', pinyin: 'q√≠ng', meaning: 'sunny' },

            // Additional phonetic groups
            { char: '‰ª¨', pinyin: 'men', meaning: 'plural marker' },
            { char: 'Âêó', pinyin: 'ma', meaning: 'question particle' },
            { char: 'Âêß', pinyin: 'ba', meaning: 'suggestion particle' },
            { char: 'Âë¢', pinyin: 'ne', meaning: 'question particle' },
            { char: 'ÁöÑ', pinyin: 'de', meaning: 'possessive particle' },
            { char: 'Âú∞', pinyin: 'de/d√¨', meaning: 'ground/adverbial particle' },
            { char: 'Âæó', pinyin: 'de/d√©/dƒõi', meaning: 'get/complement particle' },
            { char: 'Êó∂', pinyin: 'sh√≠', meaning: 'time' },
            { char: 'ÂÄô', pinyin: 'h√≤u', meaning: 'time/season' },
            { char: 'Èó¥', pinyin: 'jiƒÅn', meaning: 'between/room' },
            { char: 'Êòé', pinyin: 'm√≠ng', meaning: 'bright/tomorrow' },
            { char: 'Êòü', pinyin: 'xƒ´ng', meaning: 'star' },
            { char: 'Êúü', pinyin: 'qƒ´', meaning: 'period' },
            { char: 'Â§©', pinyin: 'tiƒÅn', meaning: 'sky/day' },
            { char: 'Âπ¥', pinyin: 'ni√°n', meaning: 'year' },
            { char: 'ÁÇπ', pinyin: 'di«én', meaning: 'point/o\'clock' },
            { char: 'ÂàÜ', pinyin: 'fƒìn', meaning: 'minute/divide' },
            { char: 'Áßí', pinyin: 'mi«éo', meaning: 'second' },
            { char: 'Âàª', pinyin: 'k√®', meaning: 'quarter (hour)' },
            { char: 'Âçä', pinyin: 'b√†n', meaning: 'half' },
        ];

        let currentQuestion = null;
        let mode = 'char-to-pinyin';
        let answered = false;
        let score = 0;
        let total = 0;

        // DOM elements
        const questionDisplay = document.getElementById('questionDisplay');
        const answerInput = document.getElementById('answerInput');
        const checkBtn = document.getElementById('checkBtn');
        const feedback = document.getElementById('feedback');
        const hint = document.getElementById('hint');
        const typeMode = document.getElementById('typeMode');
        const choiceMode = document.getElementById('choiceMode');
        const fuzzyMode = document.getElementById('fuzzyMode');
        const fuzzyInput = document.getElementById('fuzzyInput');
        const audioSection = document.getElementById('audioSection');
        const strokeOrderMode = document.getElementById('strokeOrderMode');
        const handwritingMode = document.getElementById('handwritingMode');
        const drawCharMode = document.getElementById('drawCharMode');

        // Hanzi Writer variable
        let writer = null;

        // Sound effect functions
        // Sound functions now loaded from utils.js

        // Canvas drawing variables
        let canvas, ctx;
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        let strokes = [];
        let currentStroke = [];
        let ocrTimeout = null;

        function initCanvas() {
            canvas = document.getElementById('drawCanvas');
            ctx = canvas.getContext('2d');
            ctx.lineWidth = 8;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.strokeStyle = '#000';

            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);

            // Touch support
            canvas.addEventListener('touchstart', handleTouchStart);
            canvas.addEventListener('touchmove', handleTouchMove);
            canvas.addEventListener('touchend', stopDrawing);

            strokes = [];
        }

        function getCanvasCoords(e) {
            const rect = canvas.getBoundingClientRect();

            if (e.touches && e.touches[0]) {
                return {
                    x: e.touches[0].clientX - rect.left,
                    y: e.touches[0].clientY - rect.top
                };
            }
            return {
                x: e.clientX - rect.left,
                y: e.clientY - rect.top
            };
        }

        function startDrawing(e) {
            isDrawing = true;
            const coords = getCanvasCoords(e);
            lastX = coords.x;
            lastY = coords.y;
            currentStroke = [[coords.x, coords.y]];
        }

        function draw(e) {
            if (!isDrawing) return;
            e.preventDefault();

            const coords = getCanvasCoords(e);
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(coords.x, coords.y);
            ctx.stroke();

            currentStroke.push([coords.x, coords.y]);
            lastX = coords.x;
            lastY = coords.y;
        }

        function stopDrawing() {
            if (isDrawing && currentStroke.length > 0) {
                strokes.push(currentStroke);
                currentStroke = [];

                // Trigger OCR after drawing stops
                if (ocrTimeout) clearTimeout(ocrTimeout);
                ocrTimeout = setTimeout(runOCR, 500);
            }
            isDrawing = false;
        }

        function handleTouchStart(e) {
            e.preventDefault();
            startDrawing(e);
        }

        function handleTouchMove(e) {
            if (!isDrawing) return;
            e.preventDefault();
            draw(e);
        }

        async function runOCR() {
            if (strokes.length === 0) return;

            try {
                const data = {
                    options: 'enable_pre_space',
                    requests: [{
                        writing_guide: {
                            writing_area_width: canvas.width,
                            writing_area_height: canvas.height
                        },
                        ink: strokes,
                        language: 'zh_CN'
                    }]
                };

                const response = await fetch('https://inputtools.google.com/request?ime=handwriting&app=mobilesearch&cs=1&oe=UTF-8', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result && result[1] && result[1][0] && result[1][0][1]) {
                    const topResult = result[1][0][1][0];
                    document.getElementById('ocrResult').textContent = topResult;
                }
            } catch (error) {
                console.error('OCR error:', error);
            }
        }

        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            strokes = [];
            document.getElementById('ocrResult').textContent = '';
        }

        document.getElementById('clearCanvasBtn').addEventListener('click', clearCanvas);
        document.getElementById('submitDrawBtn').addEventListener('click', () => {
            if (answered) return;

            const recognizedText = document.getElementById('ocrResult').textContent.trim();
            const correct = recognizedText.includes(currentQuestion.char);

            answered = true;
            total++;

            if (correct) {
                playCorrectSound();
                score++;
                feedback.textContent = `‚úì Correct! You drew ${currentQuestion.char} (${currentQuestion.pinyin})`;
                feedback.className = 'text-green-600';
                hint.textContent = `Meaning: ${currentQuestion.meaning}`;
                hint.className = 'text-green-600';
            } else {
                playWrongSound();
                feedback.textContent = `‚úó Wrong. You drew: ${recognizedText || '(nothing recognized)'}. The answer was: ${currentQuestion.char}`;
                feedback.className = 'text-red-600';
                hint.textContent = `${currentQuestion.char} (${currentQuestion.pinyin}) - ${currentQuestion.meaning}`;
                hint.className = 'text-red-600';
            }

            updateStats();

            setTimeout(() => {
                clearCanvas();
                generateQuestion();
            }, 2000);
        });

        // Mode switching
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.mode-btn').forEach(b => {
                    b.classList.remove('active', 'bg-blue-500', 'text-white', 'border-blue-500');
                });
                btn.classList.add('active', 'bg-blue-500', 'text-white', 'border-blue-500');
                mode = btn.dataset.mode;
                generateQuestion();
            });
        });

        // pinyinToAudioKey now loaded from utils.js

        function generateQuestion() {
            answered = false;
            feedback.textContent = '';
            hint.textContent = '';
            answerInput.value = '';
            fuzzyInput.value = '';

            currentQuestion = characters[Math.floor(Math.random() * characters.length)];

            // Hide all modes
            typeMode.classList.add('hidden');
            choiceMode.classList.add('hidden');
            fuzzyMode.classList.add('hidden');
            audioSection.classList.add('hidden');
            strokeOrderMode.classList.add('hidden');
            handwritingMode.classList.add('hidden');
            drawCharMode.classList.add('hidden');

            if (mode === 'char-to-pinyin') {
                questionDisplay.innerHTML = `<div class="text-8xl my-10 text-center">${currentQuestion.char}</div>`;
                answerInput.placeholder = 'e.g., m«é or ma3';
                typeMode.classList.remove('hidden');
                audioSection.classList.remove('hidden');
                document.getElementById('playAudioBtn').onclick = () => {
                    const firstPinyin = currentQuestion.pinyin.split('/').map(p => p.trim())[0];
                    const audioKey = pinyinToAudioKey(firstPinyin);
                    if (audioKey) {
                        const audioUrl = `https://www.purpleculture.net/mp3/${audioKey}.mp3`;
                        if (window.currentAudio) {
                            window.currentAudio.pause();
                            window.currentAudio.currentTime = 0;
                        }
                        window.currentAudio = new Audio(audioUrl);
                        window.currentAudio.play().catch(e => console.log('Audio play failed:', e));
                    }
                };
                answerInput.focus();
            } else if (mode === 'audio-to-pinyin') {
                questionDisplay.innerHTML = `<div class="text-center my-10"><button class="bg-cyan-500 hover:bg-cyan-600 text-white text-2xl px-10 py-5 rounded-lg" id="playAudioDictation">üîä Play Audio</button></div><div class="text-center text-gray-500 text-sm mt-5">Type with tone marks (m«é) or numbers (ma3)</div>`;
                answerInput.placeholder = 'e.g., m«é or ma3';
                typeMode.classList.remove('hidden');

                setTimeout(() => {
                    const playBtn = document.getElementById('playAudioDictation');

                    window.currentAudioPlayFunc = () => {
                        const firstPinyin = currentQuestion.pinyin.split('/').map(p => p.trim())[0];
                        const audioKey = pinyinToAudioKey(firstPinyin);
                        if (audioKey) {
                            const audioUrl = `https://www.purpleculture.net/mp3/${audioKey}.mp3`;
                            if (window.currentAudio) {
                                window.currentAudio.pause();
                                window.currentAudio.currentTime = 0;
                            }
                            window.currentAudio = new Audio(audioUrl);
                            window.currentAudio.play().catch(e => console.log('Audio play failed:', e));
                        }
                    };

                    if (playBtn) {
                        playBtn.onclick = window.currentAudioPlayFunc;
                    }

                    window.currentAudioPlayFunc();
                    answerInput.focus();
                }, 100);
            } else if (mode === 'pinyin-to-char') {
                questionDisplay.innerHTML = `<div class="text-5xl my-10 text-center">${currentQuestion.pinyin}</div>`;
                generateCharOptions();
            } else if (mode === 'char-to-pinyin-mc') {
                questionDisplay.innerHTML = `<div class="text-8xl my-10 text-center">${currentQuestion.char}</div>`;
                generatePinyinOptions();
            } else if (mode === 'char-to-meaning-type') {
                questionDisplay.innerHTML = `<div class="text-8xl my-10 text-center">${currentQuestion.char}</div>`;
                generateFuzzyMeaningOptions();
            } else if (mode === 'meaning-to-char') {
                questionDisplay.innerHTML = `<div class="text-3xl my-10 text-center">${currentQuestion.meaning}</div>`;
                generateCharOptions();
            } else if (mode === 'stroke-order') {
                questionDisplay.innerHTML = `<div class="text-2xl my-4 text-center text-gray-600">${currentQuestion.pinyin} - ${currentQuestion.meaning}</div>`;
                strokeOrderMode.classList.remove('hidden');
                initStrokeOrder();
            } else if (mode === 'handwriting') {
                questionDisplay.innerHTML = `<div class="text-2xl my-4 text-center text-gray-600">${currentQuestion.pinyin} - ${currentQuestion.meaning}</div>`;
                handwritingMode.classList.remove('hidden');
                initHandwriting();

                // Play audio when question loads
                setTimeout(() => {
                    const firstPinyin = currentQuestion.pinyin.split('/').map(p => p.trim())[0];
                    const audioKey = pinyinToAudioKey(firstPinyin);
                    if (audioKey) {
                        const audioUrl = `https://www.purpleculture.net/mp3/${audioKey}.mp3`;
                        const audio = new Audio(audioUrl);
                        audio.play().catch(e => console.log('Audio play failed:', e));
                    }
                }, 100);
            } else if (mode === 'draw-char') {
                questionDisplay.innerHTML = `<div class="text-3xl my-10 text-center">${currentQuestion.pinyin} - ${currentQuestion.meaning}</div>`;
                drawCharMode.classList.remove('hidden');
                if (!canvas) initCanvas();
                clearCanvas();
            }

            updateStats();
        }

        function initStrokeOrder() {
            const writerDiv = document.getElementById('strokeOrderWriter');
            writerDiv.innerHTML = '';

            writer = HanziWriter.create(writerDiv, currentQuestion.char, {
                width: 300,
                height: 300,
                padding: 5,
                showOutline: true,
                strokeAnimationSpeed: 1,
                delayBetweenStrokes: 200
            });

            // Automatically animate and advance to next question
            writer.animateCharacter({
                onComplete: () => {
                    setTimeout(() => {
                        generateQuestion();
                    }, 1000);
                }
            });
        }

        function initHandwriting() {
            const writerDiv = document.getElementById('handwritingWriter');
            writerDiv.innerHTML = '';

            writer = HanziWriter.create(writerDiv, currentQuestion.char, {
                width: 300,
                height: 300,
                padding: 5,
                showOutline: false,
                showCharacter: false,
                strokeAnimationSpeed: 1,
                delayBetweenStrokes: 50
            });

            document.getElementById('hwShowBtn').onclick = () => {
                writer.showCharacter();
                writer.showOutline();
                writer.animateCharacter();

                feedback.textContent = `${currentQuestion.char} (${currentQuestion.pinyin}) - ${currentQuestion.meaning}`;
                feedback.className = 'text-blue-600';
            };

            document.getElementById('hwNextBtn').onclick = () => {
                generateQuestion();
            };
        }

        function generatePinyinOptions() {
            const options = document.getElementById('options');
            options.innerHTML = '';

            const wrongOptions = [];
            while (wrongOptions.length < 3) {
                const random = characters[Math.floor(Math.random() * characters.length)];
                if (random.pinyin !== currentQuestion.pinyin && !wrongOptions.includes(random.pinyin)) {
                    wrongOptions.push(random.pinyin);
                }
            }

            const allOptions = [...wrongOptions, currentQuestion.pinyin];
            allOptions.sort(() => Math.random() - 0.5);

            allOptions.forEach(option => {
                const btn = document.createElement('button');
                btn.className = 'px-4 py-3 bg-gray-100 hover:bg-gray-200 rounded-lg border-2 border-gray-300 transition';
                btn.textContent = option;
                btn.onclick = () => checkMultipleChoice(option);
                options.appendChild(btn);
            });

            choiceMode.classList.remove('hidden');
        }

        function generateCharOptions() {
            const options = document.getElementById('options');
            options.innerHTML = '';

            const wrongOptions = [];
            while (wrongOptions.length < 3) {
                const random = characters[Math.floor(Math.random() * characters.length)];
                if (random.char !== currentQuestion.char && !wrongOptions.includes(random.char)) {
                    wrongOptions.push(random.char);
                }
            }

            const allOptions = [...wrongOptions, currentQuestion.char];
            allOptions.sort(() => Math.random() - 0.5);

            allOptions.forEach(option => {
                const btn = document.createElement('button');
                btn.className = 'px-4 py-3 text-4xl bg-gray-100 hover:bg-gray-200 rounded-lg border-2 border-gray-300 transition';
                btn.textContent = option;
                btn.onclick = () => checkMultipleChoice(option);
                options.appendChild(btn);
            });

            choiceMode.classList.remove('hidden');
        }

        function generateMeaningOptions() {
            const options = document.getElementById('options');
            options.innerHTML = '';

            const wrongOptions = [];
            while (wrongOptions.length < 3) {
                const random = characters[Math.floor(Math.random() * characters.length)];
                if (random.meaning !== currentQuestion.meaning && !wrongOptions.includes(random.meaning)) {
                    wrongOptions.push(random.meaning);
                }
            }

            const allOptions = [...wrongOptions, currentQuestion.meaning];
            allOptions.sort(() => Math.random() - 0.5);

            allOptions.forEach(option => {
                const btn = document.createElement('button');
                btn.className = 'px-4 py-3 bg-gray-100 hover:bg-gray-200 rounded-lg border-2 border-gray-300 transition';
                btn.textContent = option;
                btn.onclick = () => checkMultipleChoice(option);
                options.appendChild(btn);
            });

            choiceMode.classList.remove('hidden');
        }

        // fuzzyMatch now loaded from utils.js

        function generateFuzzyMeaningOptions() {
            const options = document.getElementById('fuzzyOptions');
            options.innerHTML = '';
            fuzzyInput.value = '';

            const wrongOptions = [];
            while (wrongOptions.length < 3) {
                const random = characters[Math.floor(Math.random() * characters.length)];
                if (random.char !== currentQuestion.char && !wrongOptions.includes(random.meaning)) {
                    wrongOptions.push(random.meaning);
                }
            }

            const allOptions = [...wrongOptions, currentQuestion.meaning];
            allOptions.sort(() => Math.random() - 0.5);

            allOptions.forEach((option, index) => {
                const btn = document.createElement('button');
                btn.className = 'px-4 py-3 bg-gray-100 hover:bg-gray-200 rounded-lg border-2 border-gray-300 transition';
                btn.textContent = option;
                btn.dataset.index = index;
                btn.dataset.meaning = option;
                btn.onclick = () => checkFuzzyAnswer(option);
                options.appendChild(btn);
            });

            fuzzyInput.oninput = () => {
                const input = fuzzyInput.value.trim().toLowerCase();
                if (!input) {
                    document.querySelectorAll('#fuzzyOptions button').forEach(btn => {
                        btn.classList.remove('selected');
                    });
                    return;
                }

                let bestMatch = null;
                let bestScore = -1;

                allOptions.forEach((option, index) => {
                    const score = fuzzyMatch(input, option.toLowerCase());
                    if (score > bestScore) {
                        bestScore = score;
                        bestMatch = index;
                    }
                });

                document.querySelectorAll('#fuzzyOptions button').forEach((btn, idx) => {
                    if (idx === bestMatch) {
                        btn.classList.add('selected');
                    } else {
                        btn.classList.remove('selected');
                    }
                });
            };

            fuzzyInput.onkeydown = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const selected = document.querySelector('#fuzzyOptions button.selected');
                    if (selected) {
                        selected.click();
                    }
                }
            };

            fuzzyMode.classList.remove('hidden');
            fuzzyInput.focus();
        }

        function checkFuzzyAnswer(answer) {
            if (answered) return;
            answered = true;
            total++;
            const correct = answer === currentQuestion.meaning;

            const firstPinyin = currentQuestion.pinyin.split('/').map(p => p.trim())[0];
            const audioKey = pinyinToAudioKey(firstPinyin);
            if (audioKey) {
                const audioUrl = `https://www.purpleculture.net/mp3/${audioKey}.mp3`;
                const audio = new Audio(audioUrl);
                audio.play().catch(e => console.log('Audio play failed:', e));
            }

            if (correct) {
                playCorrectSound();
                score++;
                feedback.textContent = `‚úì Correct!`;
                feedback.className = 'text-green-600';
                hint.textContent = `${currentQuestion.char} (${currentQuestion.pinyin})`;
                hint.className = 'text-green-600';

                const btn = document.querySelector(`#fuzzyOptions button[data-meaning="${answer}"]`);
                if (btn) btn.classList.add('bg-green-500', 'text-white');

                document.querySelectorAll('#fuzzyOptions button').forEach(btn => {
                    btn.disabled = true;
                    btn.classList.add('cursor-not-allowed');
                });

                updateStats();
                setTimeout(() => {
                    generateQuestion();
                }, 800);
            } else {
                playWrongSound();
                feedback.textContent = `‚úó Wrong. The answer is: ${currentQuestion.meaning}`;
                feedback.className = 'text-red-600';
                hint.textContent = `${currentQuestion.char} (${currentQuestion.pinyin})`;
                hint.className = 'text-red-600';

                document.querySelectorAll('#fuzzyOptions button').forEach(btn => {
                    if (btn.dataset.meaning === answer) {
                        btn.classList.add('bg-red-500', 'text-white');
                    }
                    if (btn.dataset.meaning === currentQuestion.meaning) {
                        btn.classList.add('bg-green-500', 'text-white');
                    }
                    btn.disabled = true;
                    btn.classList.add('cursor-not-allowed');
                });

                updateStats();
                setTimeout(() => {
                    generateQuestion();
                }, 800);
            }
        }

        function checkPinyinMatch(userAnswer, correct) {
            if (userAnswer.toLowerCase() === correct.toLowerCase()) {
                return true;
            }

            const numberedPattern = /^([a-z]+)(\d)$/i;
            const userMatch = userAnswer.match(numberedPattern);

            if (userMatch) {
                const userBase = userMatch[1].toLowerCase();
                const userTone = userMatch[2];

                const toneMap = {
                    'ƒÅ': 'a1', '√°': 'a2', '«é': 'a3', '√†': 'a4',
                    'ƒì': 'e1', '√©': 'e2', 'ƒõ': 'e3', '√®': 'e4',
                    'ƒ´': 'i1', '√≠': 'i2', '«ê': 'i3', '√¨': 'i4',
                    '≈ç': 'o1', '√≥': 'o2', '«í': 'o3', '√≤': 'o4',
                    '≈´': 'u1', '√∫': 'u2', '«î': 'u3', '√π': 'u4',
                    '«ñ': 'u1', '«ò': 'u2', '«ö': 'u3', '«ú': 'u4'
                };

                let correctBase = correct;
                let correctTone = '';

                for (const [marked, numbered] of Object.entries(toneMap)) {
                    if (correct.includes(marked)) {
                        correctBase = correct.replace(marked, numbered[0]);
                        correctTone = numbered[1];
                        break;
                    }
                }

                return userBase === correctBase && userTone === correctTone;
            }

            return false;
        }

        function checkAnswer() {
            if (!answerInput.value.trim()) return;

            const userAnswer = answerInput.value.trim();

            if (mode === 'char-to-pinyin' || mode === 'audio-to-pinyin') {
                const pinyinOptions = currentQuestion.pinyin.split('/').map(p => p.trim());
                const correct = pinyinOptions.some(option => checkPinyinMatch(userAnswer, option));

                if (mode === 'char-to-pinyin') {
                    const firstPinyin = pinyinOptions[0];
                    const audioKey = pinyinToAudioKey(firstPinyin);
                    if (audioKey) {
                        const audioUrl = `https://www.purpleculture.net/mp3/${audioKey}.mp3`;
                        const audio = new Audio(audioUrl);
                        audio.play().catch(e => console.log('Audio play failed:', e));
                    }
                }

                if (correct) {
                    playCorrectSound();
                    if (!answered) {
                        answered = true;
                        total++;
                        score++;
                    }
                    if (mode === 'audio-to-pinyin') {
                        feedback.textContent = `‚úì Correct! ${currentQuestion.pinyin} (${currentQuestion.char})`;
                    } else {
                        feedback.textContent = `‚úì Correct! ${currentQuestion.char} = ${currentQuestion.pinyin}`;
                    }
                    feedback.className = 'text-green-600';
                    hint.textContent = `Meaning: ${currentQuestion.meaning}`;
                    hint.className = 'text-green-600';
                    setTimeout(() => {
                        generateQuestion();
                    }, 300);
                } else {
                    playWrongSound();
                    if (!answered) {
                        answered = true;
                        total++;
                    }
                    if (mode === 'audio-to-pinyin') {
                        feedback.textContent = `‚úó Wrong. The answer is: ${currentQuestion.pinyin} (${currentQuestion.char}). Try again!`;
                    } else {
                        feedback.textContent = `‚úó Wrong. The answer is: ${currentQuestion.pinyin}. Try again!`;
                    }
                    feedback.className = 'text-red-600';
                    hint.textContent = `Meaning: ${currentQuestion.meaning}`;
                    hint.className = 'text-red-600';
                    setTimeout(() => {
                        answerInput.value = '';
                        answerInput.focus();
                    }, 0);
                }

                updateStats();
            }
        }

        function checkMultipleChoice(answer) {
            if (answered) return;

            answered = true;
            total++;

            let correct = false;

            if (mode === 'char-to-pinyin-mc') {
                correct = answer === currentQuestion.pinyin;
            } else if (mode === 'pinyin-to-char') {
                correct = answer === currentQuestion.char;
            } else if (mode === 'meaning-to-char') {
                correct = answer === currentQuestion.char;
            }

            if (correct) {
                playCorrectSound();
                score++;
                feedback.textContent = `‚úì Correct!`;
                feedback.className = 'text-green-600';
                hint.textContent = `${currentQuestion.char} (${currentQuestion.pinyin}) - ${currentQuestion.meaning}`;
                hint.className = 'text-green-600';

                document.querySelectorAll('#options button').forEach(btn => {
                    if (btn.textContent === answer) {
                        btn.classList.add('bg-green-500', 'text-white');
                    }
                    btn.disabled = true;
                    btn.classList.add('cursor-not-allowed');
                });

                updateStats();
                setTimeout(() => {
                    generateQuestion();
                }, 1000);
            } else {
                playWrongSound();
                feedback.textContent = `‚úó Wrong!`;
                feedback.className = 'text-red-600';
                hint.textContent = `${currentQuestion.char} (${currentQuestion.pinyin}) - ${currentQuestion.meaning}`;
                hint.className = 'text-red-600';

                document.querySelectorAll('#options button').forEach(btn => {
                    if (btn.textContent === answer) {
                        btn.classList.add('bg-red-500', 'text-white');
                    } else if ((mode === 'pinyin-to-char' || mode === 'meaning-to-char') && btn.textContent === currentQuestion.char) {
                        btn.classList.add('bg-green-500', 'text-white');
                    } else if (mode === 'char-to-pinyin-mc' && btn.textContent === currentQuestion.pinyin) {
                        btn.classList.add('bg-green-500', 'text-white');
                    }
                    btn.disabled = true;
                    btn.classList.add('cursor-not-allowed');
                });

                updateStats();
                setTimeout(() => {
                    generateQuestion();
                }, 1500);
            }
        }

        function updateStats() {
            document.getElementById('score').textContent = score;
            document.getElementById('total').textContent = total;
            const accuracy = total === 0 ? 0 : Math.round((score / total) * 100);
            document.getElementById('accuracy').textContent = accuracy + '%';
        }

        checkBtn.addEventListener('click', checkAnswer);

        answerInput.addEventListener('keydown', (e) => {
            if (e.key === ' ' && mode === 'audio-to-pinyin') {
                e.preventDefault();
                if (window.currentAudioPlayFunc) {
                    window.currentAudioPlayFunc();
                }
            } else if (e.key === 'Enter') {
                e.preventDefault();
                checkAnswer();
            }
        });

        // Initialize
        generateQuestion();
    </script>
</body>
</html>
