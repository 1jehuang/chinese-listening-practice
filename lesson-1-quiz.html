<!DOCTYPE html>
<html lang="zh-CN" translate="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google" content="notranslate">
    <title>Lesson 1: Two Maps - Quiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5/dist/hanzi-writer.min.js"></script>
    <link rel="stylesheet" href="css/common.css">
    <script src="js/utils.js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8">
    <a href="home.html" class="fixed top-4 left-4 bg-white hover:bg-gray-100 text-gray-700 px-3 py-2 rounded-lg shadow border border-gray-200 transition text-sm">← Home</a>

    <div class="max-w-3xl mx-auto bg-white rounded-xl shadow-lg p-6 md:p-8 mt-16 md:mt-0">
        <h1 class="text-3xl font-bold text-center mb-6 text-gray-800">Lesson 1: 两张地图 (Two Maps)</h1>

        <!-- Mode Selector -->
        <div class="flex flex-wrap gap-2 justify-center mb-6">
            <button class="mode-btn px-4 py-2 rounded-lg border-2 border-gray-300 hover:bg-gray-100 transition active:bg-blue-500 active:text-white active:border-blue-500" data-mode="char-to-pinyin">Char → Pinyin</button>
            <button class="mode-btn px-4 py-2 rounded-lg border-2 border-gray-300 hover:bg-gray-100 transition" data-mode="char-to-pinyin-mc">Char → Pinyin (MC)</button>
            <button class="mode-btn px-4 py-2 rounded-lg border-2 border-gray-300 hover:bg-gray-100 transition" data-mode="audio-to-pinyin">Audio → Pinyin</button>
            <button class="mode-btn px-4 py-2 rounded-lg border-2 border-gray-300 hover:bg-gray-100 transition" data-mode="pinyin-to-char">Pinyin → Char</button>
            <button class="mode-btn px-4 py-2 rounded-lg border-2 border-gray-300 hover:bg-gray-100 transition" data-mode="char-to-meaning-type">Char → Meaning</button>
            <button class="mode-btn px-4 py-2 rounded-lg border-2 border-gray-300 hover:bg-gray-100 transition" data-mode="meaning-to-char">Meaning → Char</button>
            <button class="mode-btn px-4 py-2 rounded-lg border-2 border-gray-300 hover:bg-gray-100 transition" data-mode="stroke-order">Stroke Order</button>
            <button class="mode-btn px-4 py-2 rounded-lg border-2 border-gray-300 hover:bg-gray-100 transition" data-mode="handwriting">Handwriting</button>
            <button class="mode-btn px-4 py-2 rounded-lg border-2 border-gray-300 hover:bg-gray-100 transition" data-mode="draw-char">Draw Character</button>
        </div>

        <!-- Question Display -->
        <div id="questionDisplay" class="text-center"></div>

        <!-- Hint -->
        <div id="hint" class="text-center text-2xl font-semibold my-4 min-h-[20px]"></div>

        <!-- Audio Section -->
        <div id="audioSection" class="text-center my-4 hidden">
            <button id="playAudioBtn" class="bg-cyan-500 hover:bg-cyan-600 text-white px-6 py-3 rounded-lg transition">🔊 Play Sound</button>
        </div>

        <!-- Type Mode -->
        <div id="typeMode" class="space-y-4">
            <input type="text" id="answerInput" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none text-lg" placeholder="Type your answer...">
            <button id="checkBtn" class="w-full bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg font-semibold transition">Check Answer</button>
        </div>

        <!-- Choice Mode -->
        <div id="choiceMode" class="hidden">
            <div id="options" class="grid grid-cols-2 gap-3"></div>
        </div>

        <!-- Fuzzy Mode -->
        <div id="fuzzyMode" class="hidden space-y-4">
            <input type="text" id="fuzzyInput" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none text-lg" placeholder="Type your answer...">
            <div id="fuzzyOptions" class="grid grid-cols-2 gap-3"></div>
        </div>

        <!-- Stroke Order Mode -->
        <div id="strokeOrderMode" class="hidden">
            <div id="strokeOrderWriter" class="flex justify-center my-8"></div>
        </div>

        <!-- Handwriting Mode -->
        <div id="handwritingMode" class="hidden">
            <div class="text-center text-gray-600 mb-4">Practice writing on paper, then reveal the answer</div>
            <div id="handwritingWriter" class="flex justify-center my-8"></div>
            <div class="flex justify-center gap-3">
                <button id="hwShowBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-8 py-3 rounded-lg transition text-lg">Show Answer / Replay</button>
                <button id="hwNextBtn" class="bg-green-500 hover:bg-green-600 text-white px-8 py-3 rounded-lg transition text-lg">Next</button>
            </div>
        </div>

        <!-- Draw Character Mode -->
        <div id="drawCharMode" class="hidden">
            <div class="text-center mb-4">
                <div id="ocrResult" class="text-6xl min-h-[80px] text-blue-600 font-bold"></div>
                <div class="text-sm text-gray-500">Real-time recognition</div>
            </div>
            <canvas id="drawCanvas" class="border-2 border-gray-300 rounded-lg mx-auto cursor-crosshair" width="300" height="300"></canvas>
            <div class="flex gap-3 justify-center mt-4">
                <button id="clearCanvasBtn" class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg transition">🗑️ Clear</button>
                <button id="submitDrawBtn" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg transition">✓ Submit</button>
            </div>
        </div>

        <!-- Feedback -->
        <div id="feedback" class="text-center text-2xl font-semibold my-4 min-h-[24px]"></div>

        <!-- Stats -->
        <div class="flex justify-between text-sm text-gray-600 pt-4 border-t border-gray-200">
            <span>Score: <span id="score" class="font-semibold">0</span>/<span id="total" class="font-semibold">0</span></span>
            <span>Accuracy: <span id="accuracy" class="font-semibold">0%</span></span>
        </div>
    </div>

    <script>
        const characters = [
            { char: '第', pinyin: 'dì', meaning: 'ordinal prefix (-st, -nd, -rd, -th)' },
            { char: '课', pinyin: 'kè', meaning: 'lesson' },
            { char: '两', pinyin: 'liǎng', meaning: 'two (used with AN)' },
            { char: '张', pinyin: 'zhāng', meaning: 'measure word for flat things' },
            { char: '地图', pinyin: 'dìtú', meaning: 'map' },
            { char: '甲', pinyin: 'jiǎ', meaning: 'person A' },
            { char: '这', pinyin: 'zhè', meaning: 'this; these' },
            { char: '是', pinyin: 'shì', meaning: 'is; am; are' },
            { char: '什么', pinyin: 'shém.me', meaning: 'what' },
            { char: '比', pinyin: 'bǐ', meaning: 'compare' },
            { char: '大', pinyin: 'dà', meaning: 'big' },
            { char: '一点儿', pinyin: 'yìdiǎnr', meaning: 'a little' },
            { char: '年', pinyin: 'nián', meaning: 'year' },
            { char: '以前', pinyin: 'yǐqián', meaning: 'before' },
            { char: '那时', pinyin: 'nàshí', meaning: 'that time' },
            { char: '还', pinyin: 'hái', meaning: 'still; also' },
            { char: '包括', pinyin: 'bāokuò', meaning: 'include' },
            { char: '现在', pinyin: 'xiànzài', meaning: 'now' },
            { char: '蒙古国', pinyin: 'Měnggǔguó', meaning: 'Mongolia' },
            { char: '哦', pinyin: 'ò', meaning: 'oh; I see' },
            { char: '我', pinyin: 'wǒ', meaning: 'I; me' },
            { char: '懂', pinyin: 'dǒng', meaning: 'understand' },
            { char: '了', pinyin: 'le', meaning: 'particle for new situation' },
            { char: '历史', pinyin: 'lì.shi', meaning: 'history' },
            { char: '上', pinyin: 'shàng', meaning: 'in; on' },
            { char: '对了', pinyin: 'duì.le', meaning: "that's right" },
            { char: '可是', pinyin: 'kě.shì', meaning: 'however; but' },
            { char: '完全', pinyin: 'wánquán', meaning: 'completely; entirely' },
            { char: '他们', pinyin: 'tā.men', meaning: 'they' },
            { char: '搬', pinyin: 'bān', meaning: 'move' },
            { char: '到…去', pinyin: 'dào...qù', meaning: 'go to...' },
            { char: '台湾', pinyin: 'Táiwān', meaning: 'Taiwan' },
            { char: '就是', pinyin: 'jiù.shì', meaning: 'be exactly' },
            { char: '和', pinyin: 'hé', meaning: 'and' },
            { char: '政府', pinyin: 'zhèng.fǔ', meaning: 'government' },
            { char: '都', pinyin: 'dōu', meaning: 'in all cases' },
            { char: '说', pinyin: 'shuō', meaning: 'speak; say; talk' },
            { char: '只有', pinyin: 'zhǐyǒu', meaning: "there's only" },
            { char: '个', pinyin: 'gè', meaning: 'general measure word' },
            { char: '而', pinyin: 'ér', meaning: 'and; yet' },
            { char: '部分', pinyin: 'bù.fèn', meaning: 'part' },
            { char: '国家', pinyin: 'guójiā', meaning: 'country' },
            { char: '对不对', pinyin: 'duì.bu.duì', meaning: 'Is it correct?' },
            { char: '很难说', pinyin: 'hěnnánshuō', meaning: "It's hard to say" }
        ];

        let currentQuestion = null;
        let mode = 'char-to-pinyin';
        let answered = false;
        let score = 0;
        let total = 0;

        // DOM elements
        const questionDisplay = document.getElementById('questionDisplay');
        const answerInput = document.getElementById('answerInput');
        const checkBtn = document.getElementById('checkBtn');
        const feedback = document.getElementById('feedback');
        const hint = document.getElementById('hint');
        const typeMode = document.getElementById('typeMode');
        const choiceMode = document.getElementById('choiceMode');
        const fuzzyMode = document.getElementById('fuzzyMode');
        const fuzzyInput = document.getElementById('fuzzyInput');
        const audioSection = document.getElementById('audioSection');
        const strokeOrderMode = document.getElementById('strokeOrderMode');
        const handwritingMode = document.getElementById('handwritingMode');
        const drawCharMode = document.getElementById('drawCharMode');

        // Hanzi Writer variable
        let writer = null;

        // Sound effect functions
        // Sound functions now loaded from utils.js

        // Canvas drawing variables
        let canvas, ctx;
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        let strokes = [];
        let currentStroke = [];
        let ocrTimeout = null;

        function initCanvas() {
            canvas = document.getElementById('drawCanvas');
            ctx = canvas.getContext('2d');
            ctx.lineWidth = 8;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.strokeStyle = '#000';

            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);

            // Touch support
            canvas.addEventListener('touchstart', handleTouchStart);
            canvas.addEventListener('touchmove', handleTouchMove);
            canvas.addEventListener('touchend', stopDrawing);

            strokes = [];
        }

        function getCanvasCoords(e) {
            const rect = canvas.getBoundingClientRect();

            if (e.touches && e.touches[0]) {
                return {
                    x: e.touches[0].clientX - rect.left,
                    y: e.touches[0].clientY - rect.top
                };
            }
            return {
                x: e.clientX - rect.left,
                y: e.clientY - rect.top
            };
        }

        function startDrawing(e) {
            isDrawing = true;
            const coords = getCanvasCoords(e);
            lastX = coords.x;
            lastY = coords.y;
            currentStroke = [[coords.x, coords.y]];
        }

        function draw(e) {
            if (!isDrawing) return;
            e.preventDefault();

            const coords = getCanvasCoords(e);
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(coords.x, coords.y);
            ctx.stroke();

            currentStroke.push([coords.x, coords.y]);
            lastX = coords.x;
            lastY = coords.y;
        }

        function stopDrawing() {
            if (isDrawing && currentStroke.length > 0) {
                strokes.push(currentStroke);
                currentStroke = [];

                // Trigger OCR after drawing stops
                if (ocrTimeout) clearTimeout(ocrTimeout);
                ocrTimeout = setTimeout(runOCR, 500);
            }
            isDrawing = false;
        }

        function handleTouchStart(e) {
            e.preventDefault();
            startDrawing(e);
        }

        function handleTouchMove(e) {
            if (!isDrawing) return;
            e.preventDefault();
            draw(e);
        }

        async function runOCR() {
            if (strokes.length === 0) return;

            try {
                const data = {
                    options: 'enable_pre_space',
                    requests: [{
                        writing_guide: {
                            writing_area_width: canvas.width,
                            writing_area_height: canvas.height
                        },
                        ink: strokes,
                        language: 'zh_CN'
                    }]
                };

                const response = await fetch('https://www.google.com.tw/inputtools/request?ime=handwriting&app=mobilesearch&cs=1&oe=UTF-8', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result && result[1] && result[1][0] && result[1][0][1]) {
                    const topResult = result[1][0][1][0];
                    document.getElementById('ocrResult').textContent = topResult;
                }
            } catch (error) {
                console.error('OCR error:', error);
            }
        }

        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            strokes = [];
            document.getElementById('ocrResult').textContent = '';
        }

        document.getElementById('clearCanvasBtn').addEventListener('click', clearCanvas);
        document.getElementById('submitDrawBtn').addEventListener('click', () => {
            if (answered) return;

            const recognizedText = document.getElementById('ocrResult').textContent.trim();
            const correct = recognizedText.includes(currentQuestion.char);

            answered = true;
            total++;

            if (correct) {
                playCorrectSound();
                score++;
                feedback.textContent = `✓ Correct! You drew ${currentQuestion.char} (${currentQuestion.pinyin})`;
                feedback.className = 'text-center text-2xl font-semibold my-4 min-h-[24px] text-green-600';
                hint.textContent = `Meaning: ${currentQuestion.meaning}`;
                hint.className = 'text-center text-2xl font-semibold my-4 min-h-[20px] text-green-600';
            } else {
                playWrongSound();
                feedback.textContent = `✗ Wrong. You drew: ${recognizedText || '(nothing recognized)'}. The answer was: ${currentQuestion.char}`;
                feedback.className = 'text-center text-2xl font-semibold my-4 min-h-[24px] text-red-600';
                hint.textContent = `${currentQuestion.char} (${currentQuestion.pinyin}) - ${currentQuestion.meaning}`;
                hint.className = 'text-center text-2xl font-semibold my-4 min-h-[20px] text-red-600';
            }

            updateStats();

            setTimeout(() => {
                clearCanvas();
                generateQuestion();
            }, 2000);
        });

        // Mode switching
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.mode-btn').forEach(b => {
                    b.classList.remove('active', 'bg-blue-500', 'text-white', 'border-blue-500');
                });
                btn.classList.add('active', 'bg-blue-500', 'text-white', 'border-blue-500');
                mode = btn.dataset.mode;
                generateQuestion();
            });
        });

        // pinyinToAudioKey now loaded from utils.js

        function generateQuestion() {
            answered = false;
            feedback.textContent = '';
            hint.textContent = '';
            answerInput.value = '';
            fuzzyInput.value = '';

            currentQuestion = characters[Math.floor(Math.random() * characters.length)];

            // Hide all modes
            typeMode.classList.add('hidden');
            choiceMode.classList.add('hidden');
            fuzzyMode.classList.add('hidden');
            audioSection.classList.add('hidden');
            strokeOrderMode.classList.add('hidden');
            handwritingMode.classList.add('hidden');
            drawCharMode.classList.add('hidden');

            if (mode === 'char-to-pinyin') {
                questionDisplay.innerHTML = `<div class="text-8xl my-10 text-center">${currentQuestion.char}</div>`;
                answerInput.placeholder = 'e.g., mǎ or ma3';
                typeMode.classList.remove('hidden');
                audioSection.classList.remove('hidden');
                document.getElementById('playAudioBtn').onclick = () => {
                    const firstPinyin = currentQuestion.pinyin.split('/').map(p => p.trim())[0];
                    playPinyinAudio(firstPinyin, currentQuestion.char);
                };
                answerInput.focus();
            } else if (mode === 'audio-to-pinyin') {
                questionDisplay.innerHTML = `<div class="text-center my-10"><button class="bg-cyan-500 hover:bg-cyan-600 text-white text-2xl px-10 py-5 rounded-lg" id="playAudioDictation">🔊 Play Audio</button></div><div class="text-center text-gray-500 text-sm mt-5">Type with tone marks (mǎ) or numbers (ma3)</div>`;
                answerInput.placeholder = 'e.g., mǎ or ma3';
                typeMode.classList.remove('hidden');

                setTimeout(() => {
                    const playBtn = document.getElementById('playAudioDictation');

                    window.currentAudioPlayFunc = () => {
                        const firstPinyin = currentQuestion.pinyin.split('/').map(p => p.trim())[0];
                        playPinyinAudio(firstPinyin, currentQuestion.char);
                    };

                    if (playBtn) {
                        playBtn.onclick = window.currentAudioPlayFunc;
                    }

                    window.currentAudioPlayFunc();
                    answerInput.focus();
                }, 100);
            } else if (mode === 'pinyin-to-char') {
                questionDisplay.innerHTML = `<div class="text-5xl my-10 text-center">${currentQuestion.pinyin}</div>`;
                generateCharOptions();
            } else if (mode === 'char-to-pinyin-mc') {
                questionDisplay.innerHTML = `<div class="text-8xl my-10 text-center">${currentQuestion.char}</div>`;
                generatePinyinOptions();
            } else if (mode === 'char-to-meaning-type') {
                questionDisplay.innerHTML = `<div class="text-8xl my-10 text-center">${currentQuestion.char}</div>`;
                generateFuzzyMeaningOptions();
            } else if (mode === 'meaning-to-char') {
                questionDisplay.innerHTML = `<div class="text-3xl my-10 text-center">${currentQuestion.meaning}</div>`;
                generateCharOptions();
            } else if (mode === 'stroke-order') {
                questionDisplay.innerHTML = `<div class="text-2xl my-4 text-center text-gray-600">${currentQuestion.pinyin} - ${currentQuestion.meaning}</div>`;
                strokeOrderMode.classList.remove('hidden');
                initStrokeOrder();
            } else if (mode === 'handwriting') {
                questionDisplay.innerHTML = `<div class="text-2xl my-4 text-center text-gray-600">${currentQuestion.pinyin} - ${currentQuestion.meaning}</div>`;
                handwritingMode.classList.remove('hidden');
                initHandwriting();

                // Play audio when question loads
                setTimeout(() => {
                    const firstPinyin = currentQuestion.pinyin.split('/').map(p => p.trim())[0];
                    playPinyinAudio(firstPinyin, currentQuestion.char);
                }, 100);
            } else if (mode === 'draw-char') {
                questionDisplay.innerHTML = `<div class="text-3xl my-10 text-center">${currentQuestion.pinyin} - ${currentQuestion.meaning}</div>`;
                drawCharMode.classList.remove('hidden');
                if (!canvas) initCanvas();
                clearCanvas();
            }

            updateStats();
        }

        function initStrokeOrder() {
            const writerDiv = document.getElementById('strokeOrderWriter');
            writerDiv.innerHTML = '';

            writer = HanziWriter.create(writerDiv, currentQuestion.char, {
                width: 300,
                height: 300,
                padding: 5,
                showOutline: true,
                strokeAnimationSpeed: 1,
                delayBetweenStrokes: 200
            });

            // Automatically animate and advance to next question
            writer.animateCharacter({
                onComplete: () => {
                    setTimeout(() => {
                        generateQuestion();
                    }, 1000);
                }
            });
        }

        function initHandwriting() {
            const writerDiv = document.getElementById('handwritingWriter');
            writerDiv.innerHTML = '';

            writer = HanziWriter.create(writerDiv, currentQuestion.char, {
                width: 300,
                height: 300,
                padding: 5,
                showOutline: false,
                showCharacter: false,
                strokeAnimationSpeed: 1,
                delayBetweenStrokes: 50
            });

            document.getElementById('hwShowBtn').onclick = () => {
                writer.showCharacter();
                writer.showOutline();
                writer.animateCharacter();

                feedback.textContent = `${currentQuestion.char} (${currentQuestion.pinyin}) - ${currentQuestion.meaning}`;
                feedback.className = 'text-center text-2xl font-semibold my-4 min-h-[24px] text-blue-600';
            };

            document.getElementById('hwNextBtn').onclick = () => {
                generateQuestion();
            };
        }

        function generatePinyinOptions() {
            const options = document.getElementById('options');
            options.innerHTML = '';

            const wrongOptions = [];
            while (wrongOptions.length < 3) {
                const random = characters[Math.floor(Math.random() * characters.length)];
                if (random.pinyin !== currentQuestion.pinyin && !wrongOptions.includes(random.pinyin)) {
                    wrongOptions.push(random.pinyin);
                }
            }

            const allOptions = [...wrongOptions, currentQuestion.pinyin];
            allOptions.sort(() => Math.random() - 0.5);

            allOptions.forEach(option => {
                const btn = document.createElement('button');
                btn.className = 'px-4 py-3 bg-gray-100 hover:bg-gray-200 rounded-lg border-2 border-gray-300 transition';
                btn.textContent = option;
                btn.onclick = () => checkMultipleChoice(option);
                options.appendChild(btn);
            });

            choiceMode.classList.remove('hidden');
        }

        function generateCharOptions() {
            const options = document.getElementById('options');
            options.innerHTML = '';

            const wrongOptions = [];
            while (wrongOptions.length < 3) {
                const random = characters[Math.floor(Math.random() * characters.length)];
                if (random.char !== currentQuestion.char && !wrongOptions.includes(random.char)) {
                    wrongOptions.push(random.char);
                }
            }

            const allOptions = [...wrongOptions, currentQuestion.char];
            allOptions.sort(() => Math.random() - 0.5);

            allOptions.forEach(option => {
                const btn = document.createElement('button');
                btn.className = 'px-4 py-3 text-4xl bg-gray-100 hover:bg-gray-200 rounded-lg border-2 border-gray-300 transition';
                btn.textContent = option;
                btn.onclick = () => checkMultipleChoice(option);
                options.appendChild(btn);
            });

            choiceMode.classList.remove('hidden');
        }

        function generateMeaningOptions() {
            const options = document.getElementById('options');
            options.innerHTML = '';

            const wrongOptions = [];
            while (wrongOptions.length < 3) {
                const random = characters[Math.floor(Math.random() * characters.length)];
                if (random.meaning !== currentQuestion.meaning && !wrongOptions.includes(random.meaning)) {
                    wrongOptions.push(random.meaning);
                }
            }

            const allOptions = [...wrongOptions, currentQuestion.meaning];
            allOptions.sort(() => Math.random() - 0.5);

            allOptions.forEach(option => {
                const btn = document.createElement('button');
                btn.className = 'px-4 py-3 bg-gray-100 hover:bg-gray-200 rounded-lg border-2 border-gray-300 transition';
                btn.textContent = option;
                btn.onclick = () => checkMultipleChoice(option);
                options.appendChild(btn);
            });

            choiceMode.classList.remove('hidden');
        }

        // fuzzyMatch now loaded from utils.js

        function generateFuzzyMeaningOptions() {
            const options = document.getElementById('fuzzyOptions');
            options.innerHTML = '';
            fuzzyInput.value = '';

            const wrongOptions = [];
            while (wrongOptions.length < 3) {
                const random = characters[Math.floor(Math.random() * characters.length)];
                if (random.char !== currentQuestion.char && !wrongOptions.includes(random.meaning)) {
                    wrongOptions.push(random.meaning);
                }
            }

            const allOptions = [...wrongOptions, currentQuestion.meaning];
            allOptions.sort(() => Math.random() - 0.5);

            allOptions.forEach((option, index) => {
                const btn = document.createElement('button');
                btn.className = 'px-4 py-3 bg-gray-100 hover:bg-gray-200 rounded-lg border-2 border-gray-300 transition';
                btn.textContent = option;
                btn.dataset.index = index;
                btn.dataset.meaning = option;
                btn.onclick = () => checkFuzzyAnswer(option);
                options.appendChild(btn);
            });

            fuzzyInput.oninput = () => {
                const input = fuzzyInput.value.trim().toLowerCase();
                if (!input) {
                    document.querySelectorAll('#fuzzyOptions button').forEach(btn => {
                        btn.classList.remove('selected');
                    });
                    return;
                }

                let bestMatch = null;
                let bestScore = -1;

                allOptions.forEach((option, index) => {
                    const score = fuzzyMatch(input, option.toLowerCase());
                    if (score > bestScore) {
                        bestScore = score;
                        bestMatch = index;
                    }
                });

                document.querySelectorAll('#fuzzyOptions button').forEach((btn, idx) => {
                    if (idx === bestMatch) {
                        btn.classList.add('selected');
                    } else {
                        btn.classList.remove('selected');
                    }
                });
            };

            fuzzyInput.onkeydown = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const selected = document.querySelector('#fuzzyOptions button.selected');
                    if (selected) {
                        selected.click();
                    }
                }
            };

            fuzzyMode.classList.remove('hidden');
            fuzzyInput.focus();
        }

        function checkFuzzyAnswer(answer) {
            if (answered) return;
            answered = true;
            total++;
            const correct = answer === currentQuestion.meaning;

            const firstPinyin = currentQuestion.pinyin.split('/').map(p => p.trim())[0];
            playPinyinAudio(firstPinyin, currentQuestion.char);

            if (correct) {
                playCorrectSound();
                score++;
                feedback.textContent = `✓ Correct!`;
                feedback.className = 'text-center text-2xl font-semibold my-4 min-h-[24px] text-green-600';
                hint.textContent = `${currentQuestion.char} (${currentQuestion.pinyin})`;
                hint.className = 'text-center text-2xl font-semibold my-4 min-h-[20px] text-green-600';

                const btn = document.querySelector(`#fuzzyOptions button[data-meaning="${answer}"]`);
                if (btn) btn.classList.add('bg-green-500', 'text-white');

                document.querySelectorAll('#fuzzyOptions button').forEach(btn => {
                    btn.disabled = true;
                    btn.classList.add('cursor-not-allowed');
                });

                updateStats();
                setTimeout(() => {
                    generateQuestion();
                }, 800);
            } else {
                playWrongSound();
                feedback.textContent = `✗ Wrong. The answer is: ${currentQuestion.meaning}`;
                feedback.className = 'text-center text-2xl font-semibold my-4 min-h-[24px] text-red-600';
                hint.textContent = `${currentQuestion.char} (${currentQuestion.pinyin})`;
                hint.className = 'text-center text-2xl font-semibold my-4 min-h-[20px] text-red-600';

                document.querySelectorAll('#fuzzyOptions button').forEach(btn => {
                    if (btn.dataset.meaning === answer) {
                        btn.classList.add('bg-red-500', 'text-white');
                    }
                    if (btn.dataset.meaning === currentQuestion.meaning) {
                        btn.classList.add('bg-green-500', 'text-white');
                    }
                    btn.disabled = true;
                    btn.classList.add('cursor-not-allowed');
                });

                updateStats();
                setTimeout(() => {
                    generateQuestion();
                }, 800);
            }
        }

        function checkPinyinMatch(userAnswer, correct) {
            if (userAnswer.toLowerCase() === correct.toLowerCase()) {
                return true;
            }

            const numberedPattern = /^([a-z]+)(\d)$/i;
            const userMatch = userAnswer.match(numberedPattern);

            if (userMatch) {
                const userBase = userMatch[1].toLowerCase();
                const userTone = userMatch[2];

                const toneMap = {
                    'ā': 'a1', 'á': 'a2', 'ǎ': 'a3', 'à': 'a4',
                    'ē': 'e1', 'é': 'e2', 'ě': 'e3', 'è': 'e4',
                    'ī': 'i1', 'í': 'i2', 'ǐ': 'i3', 'ì': 'i4',
                    'ō': 'o1', 'ó': 'o2', 'ǒ': 'o3', 'ò': 'o4',
                    'ū': 'u1', 'ú': 'u2', 'ǔ': 'u3', 'ù': 'u4',
                    'ǖ': 'u1', 'ǘ': 'u2', 'ǚ': 'u3', 'ǜ': 'u4'
                };

                let correctBase = correct;
                let correctTone = '';

                for (const [marked, numbered] of Object.entries(toneMap)) {
                    if (correct.includes(marked)) {
                        correctBase = correct.replace(marked, numbered[0]);
                        correctTone = numbered[1];
                        break;
                    }
                }

                return userBase === correctBase && userTone === correctTone;
            }

            return false;
        }

        function checkAnswer() {
            if (!answerInput.value.trim()) return;

            const userAnswer = answerInput.value.trim();

            if (mode === 'char-to-pinyin' || mode === 'audio-to-pinyin') {
                const pinyinOptions = currentQuestion.pinyin.split('/').map(p => p.trim());
                const correct = pinyinOptions.some(option => checkPinyinMatch(userAnswer, option));

                if (mode === 'char-to-pinyin') {
                    const firstPinyin = pinyinOptions[0];
                    playPinyinAudio(firstPinyin, currentQuestion.char);
                }

                if (correct) {
                    playCorrectSound();
                    if (!answered) {
                        answered = true;
                        total++;
                        score++;
                    }
                    if (mode === 'audio-to-pinyin') {
                        feedback.textContent = `✓ Correct! ${currentQuestion.pinyin} (${currentQuestion.char})`;
                    } else {
                        feedback.textContent = `✓ Correct! ${currentQuestion.char} = ${currentQuestion.pinyin}`;
                    }
                    feedback.className = 'text-center text-2xl font-semibold my-4 min-h-[24px] text-green-600';
                    hint.textContent = `Meaning: ${currentQuestion.meaning}`;
                    hint.className = 'text-center text-2xl font-semibold my-4 min-h-[20px] text-green-600';
                    setTimeout(() => {
                        generateQuestion();
                    }, 300);
                } else {
                    playWrongSound();
                    if (!answered) {
                        answered = true;
                        total++;
                    }
                    if (mode === 'audio-to-pinyin') {
                        feedback.textContent = `✗ Wrong. The answer is: ${currentQuestion.pinyin} (${currentQuestion.char}). Try again!`;
                    } else {
                        feedback.textContent = `✗ Wrong. The answer is: ${currentQuestion.pinyin}. Try again!`;
                    }
                    feedback.className = 'text-center text-2xl font-semibold my-4 min-h-[24px] text-red-600';
                    hint.textContent = `Meaning: ${currentQuestion.meaning}`;
                    hint.className = 'text-center text-2xl font-semibold my-4 min-h-[20px] text-red-600';
                    setTimeout(() => {
                        answerInput.value = '';
                        answerInput.focus();
                    }, 0);
                }

                updateStats();
            }
        }

        function checkMultipleChoice(answer) {
            if (answered) return;

            answered = true;
            total++;

            let correct = false;

            if (mode === 'char-to-pinyin-mc') {
                correct = answer === currentQuestion.pinyin;
            } else if (mode === 'pinyin-to-char') {
                correct = answer === currentQuestion.char;
            } else if (mode === 'meaning-to-char') {
                correct = answer === currentQuestion.char;
            }

            // Play pronunciation audio
            const firstPinyin = currentQuestion.pinyin.split('/').map(p => p.trim())[0];
            playPinyinAudio(firstPinyin, currentQuestion.char);

            if (correct) {
                playCorrectSound();
                score++;
                feedback.textContent = `✓ Correct!`;
                feedback.className = 'text-center text-2xl font-semibold my-4 min-h-[24px] text-green-600';
                hint.textContent = `${currentQuestion.char} (${currentQuestion.pinyin}) - ${currentQuestion.meaning}`;
                hint.className = 'text-center text-2xl font-semibold my-4 min-h-[20px] text-green-600';

                document.querySelectorAll('#options button').forEach(btn => {
                    if (btn.textContent === answer) {
                        btn.classList.add('bg-green-500', 'text-white');
                    }
                    btn.disabled = true;
                    btn.classList.add('cursor-not-allowed');
                });

                updateStats();
                setTimeout(() => {
                    generateQuestion();
                }, 1000);
            } else {
                playWrongSound();
                feedback.textContent = `✗ Wrong!`;
                feedback.className = 'text-center text-2xl font-semibold my-4 min-h-[24px] text-red-600';
                hint.textContent = `${currentQuestion.char} (${currentQuestion.pinyin}) - ${currentQuestion.meaning}`;
                hint.className = 'text-center text-2xl font-semibold my-4 min-h-[20px] text-red-600';

                document.querySelectorAll('#options button').forEach(btn => {
                    if (btn.textContent === answer) {
                        btn.classList.add('bg-red-500', 'text-white');
                    } else if ((mode === 'pinyin-to-char' || mode === 'meaning-to-char') && btn.textContent === currentQuestion.char) {
                        btn.classList.add('bg-green-500', 'text-white');
                    } else if (mode === 'char-to-pinyin-mc' && btn.textContent === currentQuestion.pinyin) {
                        btn.classList.add('bg-green-500', 'text-white');
                    }
                    btn.disabled = true;
                    btn.classList.add('cursor-not-allowed');
                });

                updateStats();
                setTimeout(() => {
                    generateQuestion();
                }, 1500);
            }
        }

        function updateStats() {
            document.getElementById('score').textContent = score;
            document.getElementById('total').textContent = total;
            const accuracy = total === 0 ? 0 : Math.round((score / total) * 100);
            document.getElementById('accuracy').textContent = accuracy + '%';
        }

        checkBtn.addEventListener('click', checkAnswer);

        answerInput.addEventListener('keydown', (e) => {
            if (e.key === ' ' && mode === 'audio-to-pinyin') {
                e.preventDefault();
                if (window.currentAudioPlayFunc) {
                    window.currentAudioPlayFunc();
                }
            } else if (e.key === 'Enter') {
                e.preventDefault();
                checkAnswer();
            }
        });

        // Initialize
        generateQuestion();
    </script>
</body>
</html>
