<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pinyin Quiz</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .quiz-container {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            max-width: 600px;
            width: 100%;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }

        .audio-section {
            text-align: center;
            margin: 30px 0;
        }

        .play-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 20px 40px;
            font-size: 18px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .play-button:hover {
            background: #0056b3;
            transform: scale(1.05);
        }

        .play-button:active {
            transform: scale(0.95);
        }

        .play-button.playing {
            background: #28a745;
        }

        .options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 30px 0;
        }

        .option-btn {
            padding: 20px;
            font-size: 24px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .option-btn:hover {
            background: #f8f9fa;
            border-color: #007bff;
        }

        .option-btn.correct {
            background: #d4edda;
            border-color: #28a745;
        }

        .option-btn.incorrect {
            background: #f8d7da;
            border-color: #dc3545;
        }

        .option-btn.selected {
            border-color: #007bff;
            border-width: 3px;
            background: #e3f2fd;
        }

        .feedback {
            text-align: center;
            margin: 20px 0;
            font-size: 18px;
            min-height: 30px;
        }

        .feedback.correct {
            color: #28a745;
        }

        .feedback.incorrect {
            color: #dc3545;
        }

        .next-button {
            display: block;
            width: 100%;
            padding: 15px;
            font-size: 16px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .next-button:hover {
            background: #5a6268;
        }

        .next-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .stats {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .stats-text {
            font-size: 16px;
            color: #666;
        }

        .mode-selector {
            text-align: center;
            margin-bottom: 20px;
        }

        .mode-btn {
            margin: 0 5px;
            padding: 10px 20px;
            font-size: 14px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mode-btn:hover {
            background: #e9ecef;
        }

        .mode-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .home-btn {
            position: fixed;
            top: 16px;
            left: 16px;
            padding: 8px 12px;
            background: white;
            color: #374151;
            text-decoration: none;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
        }

        .home-btn:hover {
            background: #f3f4f6;
        }
    </style>
</head>
<body>
    <a href="home.html" class="home-btn">‚Üê Home</a>
    <div class="quiz-container">
        <h1>ÊãºÈü≥ÁªÉ‰π† Pinyin Practice</h1>

        <div class="mode-selector">
            <button class="mode-btn active" data-mode="listen">Listen & Type</button>
            <button class="mode-btn" data-mode="choose">Multiple Choice</button>
            <button class="mode-btn" data-mode="tone24">Tone 2 vs 4</button>
            <button class="mode-btn" data-mode="speak">üé§ Speak</button>
        </div>

        <div class="audio-section">
            <button class="play-button" id="playBtn">üîä Play Audio</button>
        </div>

        <div id="listenMode">
            <input type="text" id="answerInput" placeholder="Type pinyin + tone (e.g., ma1, zhang4)..."
                style="width: 100%; padding: 15px; font-size: 18px; border: 2px solid #ddd; border-radius: 8px; margin: 20px 0;">
            <button id="checkBtn" style="width: 100%; padding: 15px; font-size: 16px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer;">
                Check Answer
            </button>
        </div>

        <div id="chooseMode" style="display: none;">
            <div style="text-align: center; font-size: 16px; margin-bottom: 20px; color: #666;">Which pinyin do you hear?</div>
            <div class="options" id="options"></div>
        </div>

        <div id="tone24Mode" style="display: none;">
            <div style="text-align: center; font-size: 16px; margin-bottom: 20px; color: #666;">Which tone?</div>
            <div class="options" id="tone24Options"></div>
        </div>

        <div id="speakMode" style="display: none;">
            <div style="text-align: center; font-size: 18px; margin: 30px 0; color: #333;">
                <div style="font-size: 48px; margin: 20px 0;" id="displayPinyin"></div>
                <button id="micBtn" style="padding: 30px 50px; font-size: 20px; background: #dc3545; color: white; border: none; border-radius: 50%; cursor: pointer; transition: all 0.2s;">
                    üé§ Hold to Speak
                </button>
                <div style="margin-top: 20px; color: #666; font-size: 14px;">
                    Hold the button and say the pinyin syllable
                </div>
                <div id="recognizedText" style="margin-top: 15px; font-size: 16px; color: #007bff; min-height: 25px;"></div>
            </div>
        </div>

        <div class="feedback" id="feedback"></div>

        <button class="next-button" id="nextBtn">Next Question ‚Üí</button>

        <div class="stats">
            <div class="stats-text">
                Score: <strong id="score">0</strong> / <strong id="total">0</strong>
                (<span id="percentage">0</span>%)
            </div>
        </div>
    </div>

    <script>
        // Convert pinyin with tone number to pinyin with tone marks
        function addToneMarks(pinyin, tone) {
            const toneMap = {
                'a': ['ƒÅ', '√°', '«é', '√†'],
                'e': ['ƒì', '√©', 'ƒõ', '√®'],
                'i': ['ƒ´', '√≠', '«ê', '√¨'],
                'o': ['≈ç', '√≥', '«í', '√≤'],
                'u': ['≈´', '√∫', '«î', '√π'],
                '√º': ['«ñ', '«ò', '«ö', '«ú']
            };

            if (tone < 1 || tone > 4) return pinyin;

            // Find which vowel gets the tone mark
            // Rules: a/e get it first, otherwise ou->o, otherwise last vowel
            let idx = -1;
            if (pinyin.includes('a')) idx = pinyin.indexOf('a');
            else if (pinyin.includes('e')) idx = pinyin.indexOf('e');
            else if (pinyin.includes('ou')) idx = pinyin.indexOf('o');
            else {
                // Find last vowel
                for (let i = pinyin.length - 1; i >= 0; i--) {
                    if ('aeiou√º'.includes(pinyin[i])) {
                        idx = i;
                        break;
                    }
                }
            }

            if (idx === -1) return pinyin;

            const vowel = pinyin[idx];
            const toneVowel = toneMap[vowel][tone - 1];
            return pinyin.substring(0, idx) + toneVowel + pinyin.substring(idx + 1);
        }

        const commonSyllables = [
            'ma', 'ba', 'pa', 'fa', 'da', 'ta', 'na', 'la', 'ga', 'ka', 'ha',
            'ji', 'qi', 'xi', 'zhi', 'chi', 'shi', 'ri', 'zi', 'ci', 'si',
            'bo', 'po', 'mo', 'fo', 'de', 'te', 'ne', 'le', 'ge', 'ke', 'he',
            'me', 'bu', 'pu', 'mu', 'fu', 'du', 'tu', 'nu', 'lu', 'gu', 'ku', 'hu',
            'ju', 'qu', 'xu', 'zhu', 'chu', 'shu', 'ru', 'zu', 'cu', 'su',
            'bai', 'pai', 'mai', 'dai', 'tai', 'nai', 'lai', 'gai', 'kai', 'hai',
            'bei', 'pei', 'mei', 'fei', 'dei', 'lei', 'gei', 'hei',
            'bao', 'pao', 'mao', 'dao', 'tao', 'nao', 'lao', 'gao', 'kao', 'hao',
            'dou', 'tou', 'nou', 'lou', 'gou', 'kou', 'hou',
            'ban', 'pan', 'man', 'fan', 'dan', 'tan', 'nan', 'lan', 'gan', 'kan', 'han',
            'ben', 'pen', 'men', 'fen', 'den', 'nen', 'gen', 'ken', 'hen',
            'bang', 'pang', 'mang', 'fang', 'dang', 'tang', 'nang', 'lang', 'gang', 'kang', 'hang',
            'deng', 'teng', 'neng', 'leng', 'geng', 'keng', 'heng',
            'bing', 'ping', 'ming', 'ding', 'ting', 'ning', 'ling',
            'dong', 'tong', 'nong', 'long', 'gong', 'kong', 'hong',
            'jia', 'qia', 'xia', 'jie', 'qie', 'xie', 'jiao', 'qiao', 'xiao',
            'jiu', 'qiu', 'xiu', 'jian', 'qian', 'xian', 'jin', 'qin', 'xin',
            'jiang', 'qiang', 'xiang', 'jing', 'qing', 'xing', 'jiong', 'qiong', 'xiong',
            'zha', 'cha', 'sha', 'zhe', 'che', 'she', 're', 'zhao', 'chao', 'shao', 'rao',
            'zhou', 'chou', 'shou', 'rou', 'zhan', 'chan', 'shan', 'ran',
            'zhen', 'chen', 'shen', 'ren', 'zhang', 'chang', 'shang', 'rang',
            'zheng', 'cheng', 'sheng', 'reng', 'zhong', 'chong', 'rong',
            'za', 'ca', 'sa', 'ze', 'ce', 'se', 'zao', 'cao', 'sao',
            'zou', 'cou', 'sou', 'zan', 'can', 'san', 'zen', 'cen', 'sen',
            'zang', 'cang', 'sang', 'zeng', 'ceng', 'seng', 'zong', 'cong', 'song',
            'yi', 'ya', 'yao', 'you', 'yan', 'yin', 'yang', 'ying', 'yong',
            'wu', 'wa', 'wo', 'wai', 'wei', 'wan', 'wen', 'wang', 'weng',
            'yu', 'yue', 'yuan', 'yun'
        ];

        let currentPinyin = '';
        let currentTone = 1;
        let score = 0;
        let total = 0;
        let answered = false;
        let mode = 'listen';
        let selectedOptionIndex = 0;
        let recognition = null;
        let isRecognizing = false;

        const playBtn = document.getElementById('playBtn');
        const nextBtn = document.getElementById('nextBtn');
        const feedback = document.getElementById('feedback');
        const answerInput = document.getElementById('answerInput');
        const checkBtn = document.getElementById('checkBtn');
        const listenMode = document.getElementById('listenMode');
        const chooseMode = document.getElementById('chooseMode');
        const tone24Mode = document.getElementById('tone24Mode');
        const speakMode = document.getElementById('speakMode');
        const micBtn = document.getElementById('micBtn');
        const displayPinyin = document.getElementById('displayPinyin');
        const recognizedText = document.getElementById('recognizedText');

        function generateQuestion() {
            currentPinyin = commonSyllables[Math.floor(Math.random() * commonSyllables.length)];

            if (mode === 'tone24') {
                // Only generate tone 2 or 4
                currentTone = Math.random() < 0.5 ? 2 : 4;
            } else {
                currentTone = Math.floor(Math.random() * 4) + 1;
            }

            answered = false;
            feedback.textContent = '';
            feedback.className = 'feedback';
            answerInput.value = '';

            if (mode === 'choose') {
                generateOptions();
            } else if (mode === 'tone24') {
                generateTone24Options();
            } else if (mode === 'speak') {
                displayPinyin.textContent = addToneMarks(currentPinyin, currentTone);
                recognizedText.textContent = '';
            } else {
                // Focus input in listen mode
                setTimeout(() => answerInput.focus(), 100);
            }
        }

        function generateTone24Options() {
            const options = document.getElementById('tone24Options');
            options.innerHTML = '';

            const tones = [2, 4];

            tones.forEach((tone, index) => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.textContent = addToneMarks(currentPinyin, tone);
                btn.dataset.tone = tone;
                btn.dataset.index = index;
                btn.onclick = () => checkAnswerChoice(tone, btn);
                options.appendChild(btn);
            });

            // Reset and select first option
            selectedOptionIndex = 0;
            updateSelectedOption();
        }

        function generateOptions() {
            const options = document.getElementById('options');
            options.innerHTML = '';

            // All 4 tones in order
            const tones = [1, 2, 3, 4];

            tones.forEach((tone, index) => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.textContent = addToneMarks(currentPinyin, tone);
                btn.dataset.tone = tone;
                btn.dataset.index = index;
                btn.onclick = () => checkAnswerChoice(tone, btn);
                options.appendChild(btn);
            });

            // Reset and select first option
            selectedOptionIndex = 0;
            updateSelectedOption();
        }

        function updateSelectedOption() {
            const buttons = document.querySelectorAll('.option-btn');
            buttons.forEach((btn, idx) => {
                if (idx === selectedOptionIndex) {
                    btn.classList.add('selected');
                } else {
                    btn.classList.remove('selected');
                }
            });
        }

        function selectOption(index) {
            const buttons = document.querySelectorAll('.option-btn');
            if (index >= 0 && index < buttons.length) {
                selectedOptionIndex = index;
                updateSelectedOption();
            }
        }

        function activateSelectedOption() {
            const buttons = document.querySelectorAll('.option-btn');
            if (selectedOptionIndex >= 0 && selectedOptionIndex < buttons.length) {
                buttons[selectedOptionIndex].click();
            }
        }

        function playAudio() {
            playBtn.classList.add('playing');
            const audioUrl = `https://www.purpleculture.net/mp3/${currentPinyin}${currentTone}.mp3`;
            const audio = new Audio(audioUrl);

            audio.play().catch(err => {
                console.error('Audio playback failed:', err);
                playBtn.classList.remove('playing');
            });

            audio.onended = () => {
                playBtn.classList.remove('playing');
            };
        }

        function checkAnswer(answer, btnElement = null) {
            if (!answer.trim()) return;

            // Parse input like "ma1" or "zhang4"
            const match = answer.toLowerCase().trim().match(/^([a-z]+)([1-4])$/);
            const correct = match && match[1] === currentPinyin && parseInt(match[2]) === currentTone;

            if (correct) {
                if (!answered) {
                    answered = true;
                    total++;
                    score++;
                }
                feedback.textContent = `‚úì Correct! (${currentPinyin}${currentTone})`;
                feedback.className = 'feedback correct';

                // Auto-advance to next question after correct answer
                setTimeout(() => {
                    generateQuestion();
                    playAudio();
                }, 800);
            } else {
                if (!answered) {
                    answered = true;
                    total++;
                }
                feedback.textContent = `‚úó Wrong. The answer is: ${currentPinyin}${currentTone}. Try again!`;
                feedback.className = 'feedback incorrect';
                // Clear immediately without delay
                setTimeout(() => {
                    answerInput.value = '';
                    answerInput.focus();
                }, 0);
            }

            updateStats();
        }

        function checkAnswerChoice(tone, btnElement) {
            if (answered) return;

            answered = true;
            total++;

            const correct = tone === currentTone;
            const correctPinyinWithTone = addToneMarks(currentPinyin, currentTone);

            if (correct) {
                score++;
                feedback.textContent = `‚úì Correct! (${correctPinyinWithTone})`;
                feedback.className = 'feedback correct';
                btnElement.classList.add('correct');

                // Auto-advance to next question
                setTimeout(() => {
                    generateQuestion();
                    playAudio();
                }, 800);
            } else {
                feedback.textContent = `‚úó Wrong. The answer was: ${correctPinyinWithTone}`;
                feedback.className = 'feedback incorrect';
                btnElement.classList.add('incorrect');
                document.querySelectorAll('.option-btn').forEach(btn => {
                    if (parseInt(btn.dataset.tone) === currentTone) {
                        btn.classList.add('correct');
                    }
                });

                // Auto-advance on wrong answer for multiple choice modes
                if (mode === 'choose' || mode === 'tone24') {
                    setTimeout(() => {
                        generateQuestion();
                        playAudio();
                    }, 1200);
                }
            }

            updateStats();

            document.querySelectorAll('.option-btn').forEach(btn => {
                btn.disabled = true;
                btn.style.cursor = 'not-allowed';
            });
        }

        function updateStats() {
            document.getElementById('score').textContent = score;
            document.getElementById('total').textContent = total;
            const percentage = total > 0 ? Math.round((score / total) * 100) : 0;
            document.getElementById('percentage').textContent = percentage;
        }

        playBtn.addEventListener('click', playAudio);
        nextBtn.addEventListener('click', () => {
            generateQuestion();
            playAudio();
        });

        checkBtn.addEventListener('click', () => {
            checkAnswer(answerInput.value);
        });

        answerInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                checkAnswer(answerInput.value);
            } else if (e.key === ' ') {
                e.preventDefault();
                playAudio();
            }
        });

        // Global keyboard listeners for multiple choice modes
        document.addEventListener('keydown', (e) => {
            if ((mode === 'choose' || mode === 'tone24') && !answered) {
                if (e.key === ' ') {
                    e.preventDefault();
                    playAudio();
                } else if (e.key === 'h') {
                    e.preventDefault();
                    if (mode === 'tone24') {
                        // For tone24: just 2 options side by side
                        if (selectedOptionIndex === 1) selectOption(0);
                    } else {
                        // Move left (in grid: 0,1 top row, 2,3 bottom row)
                        if (selectedOptionIndex === 1) selectOption(0);
                        else if (selectedOptionIndex === 3) selectOption(2);
                    }
                } else if (e.key === 'l') {
                    e.preventDefault();
                    if (mode === 'tone24') {
                        if (selectedOptionIndex === 0) selectOption(1);
                    } else {
                        // Move right
                        if (selectedOptionIndex === 0) selectOption(1);
                        else if (selectedOptionIndex === 2) selectOption(3);
                    }
                } else if (e.key === 'k') {
                    e.preventDefault();
                    if (mode === 'choose') {
                        // Move up
                        if (selectedOptionIndex === 2) selectOption(0);
                        else if (selectedOptionIndex === 3) selectOption(1);
                    }
                } else if (e.key === 'j') {
                    e.preventDefault();
                    if (mode === 'choose') {
                        // Move down
                        if (selectedOptionIndex === 0) selectOption(2);
                        else if (selectedOptionIndex === 1) selectOption(3);
                    }
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    activateSelectedOption();
                } else if (e.key >= '1' && e.key <= '4') {
                    e.preventDefault();
                    const index = parseInt(e.key) - 1;
                    const buttons = document.querySelectorAll('.option-btn');
                    if (index < buttons.length) {
                        selectOption(index);
                        activateSelectedOption();
                    }
                } else if (mode === 'tone24' && (e.key === '2' || e.key === '4')) {
                    e.preventDefault();
                    // Direct tone selection for tone24 mode
                    const buttons = document.querySelectorAll('.option-btn');
                    buttons.forEach((btn, idx) => {
                        if (btn.dataset.tone === e.key) {
                            selectOption(idx);
                            activateSelectedOption();
                        }
                    });
                }
            }
        });

        // Initialize speech recognition
        function initSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                alert('Speech recognition is not supported in your browser. Please use Chrome or Edge.');
                return;
            }

            recognition = new SpeechRecognition();
            recognition.lang = 'zh-CN'; // Chinese Mandarin
            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.maxAlternatives = 5;

            recognition.onstart = () => {
                isRecognizing = true;
                micBtn.style.background = '#28a745';
                micBtn.textContent = 'üé§ Listening...';
                recognizedText.textContent = 'Listening...';
            };

            recognition.onresult = (event) => {
                let transcript = '';
                let confidence = 0;

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    transcript = event.results[i][0].transcript;
                    confidence = event.results[i][0].confidence;
                }

                recognizedText.textContent = `Heard: "${transcript}" (${Math.round(confidence * 100)}% confidence)`;

                if (event.results[0].isFinal) {
                    checkSpeechAnswer(transcript);
                }
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                recognizedText.textContent = `Error: ${event.error}`;
                micBtn.style.background = '#dc3545';
                micBtn.textContent = 'üé§ Hold to Speak';
                isRecognizing = false;
            };

            recognition.onend = () => {
                isRecognizing = false;
                micBtn.style.background = '#dc3545';
                micBtn.textContent = 'üé§ Hold to Speak';
            };
        }

        function checkSpeechAnswer(transcript) {
            if (answered) return;

            const targetPinyin = addToneMarks(currentPinyin, currentTone);
            const normalizedTarget = targetPinyin.toLowerCase().trim();
            const normalizedTranscript = transcript.toLowerCase().trim();

            // Check if the recognized speech contains the target pinyin
            const correct = normalizedTranscript.includes(normalizedTarget) ||
                           normalizedTranscript === normalizedTarget ||
                           normalizedTranscript.replace(/\s/g, '') === normalizedTarget;

            if (!answered) {
                answered = true;
                total++;
            }

            if (correct) {
                score++;
                feedback.textContent = `‚úì Correct! You said "${transcript}"`;
                feedback.className = 'feedback correct';

                setTimeout(() => {
                    generateQuestion();
                }, 1500);
            } else {
                feedback.textContent = `‚úó Try again! Expected: ${targetPinyin}, You said: "${transcript}"`;
                feedback.className = 'feedback incorrect';

                // Allow retry without penalty
                setTimeout(() => {
                    answered = false;
                    total--;
                    feedback.textContent = '';
                    recognizedText.textContent = '';
                }, 2000);
            }

            updateStats();
        }

        // Microphone button controls
        if (micBtn) {
            micBtn.addEventListener('mousedown', () => {
                if (mode === 'speak' && !isRecognizing) {
                    if (!recognition) initSpeechRecognition();
                    recognition.start();
                }
            });

            micBtn.addEventListener('mouseup', () => {
                if (recognition && isRecognizing) {
                    recognition.stop();
                }
            });

            micBtn.addEventListener('mouseleave', () => {
                if (recognition && isRecognizing) {
                    recognition.stop();
                }
            });

            // Also support touch events for mobile
            micBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                if (mode === 'speak' && !isRecognizing) {
                    if (!recognition) initSpeechRecognition();
                    recognition.start();
                }
            });

            micBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                if (recognition && isRecognizing) {
                    recognition.stop();
                }
            });
        }

        // Mode selector
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                mode = btn.dataset.mode;

                // Hide all modes
                listenMode.style.display = 'none';
                chooseMode.style.display = 'none';
                tone24Mode.style.display = 'none';
                speakMode.style.display = 'none';

                // Show selected mode
                if (mode === 'listen') {
                    listenMode.style.display = 'block';
                } else if (mode === 'choose') {
                    chooseMode.style.display = 'block';
                } else if (mode === 'tone24') {
                    tone24Mode.style.display = 'block';
                } else if (mode === 'speak') {
                    speakMode.style.display = 'block';
                }

                generateQuestion();
            });
        });

        // Start first question
        generateQuestion();
        playAudio();
    </script>
</body>
</html>