<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pinyin Practice</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="css/common.css">
    <script src="js/utils.js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8">
    <a href="home.html" class="fixed top-4 left-4 bg-white hover:bg-gray-100 text-gray-700 px-3 py-2 rounded-lg shadow border border-gray-200 transition text-sm">‚Üê Home</a>

    <div class="max-w-3xl mx-auto bg-white rounded-xl shadow-lg p-6 md:p-8 mt-16 md:mt-0">
        <h1 class="text-3xl font-bold text-center mb-6 text-gray-800">Pinyin Practice</h1>

        <!-- Mode Selector -->
        <div class="flex flex-wrap gap-2 justify-center mb-6">
            <button class="mode-btn px-4 py-2 rounded-lg border-2 border-gray-300 hover:bg-gray-100 transition" data-mode="listen">Listen & Type</button>
            <button class="mode-btn px-4 py-2 rounded-lg border-2 border-gray-300 hover:bg-gray-100 transition" data-mode="choose">Multiple Choice</button>
            <button class="mode-btn px-4 py-2 rounded-lg border-2 border-gray-300 hover:bg-gray-100 transition" data-mode="tone24">Tone 2 vs 4</button>
            <button class="mode-btn px-4 py-2 rounded-lg border-2 border-gray-300 hover:bg-gray-100 transition" data-mode="double">üîäüîä Double</button>
            <button class="mode-btn px-4 py-2 rounded-lg border-2 border-gray-300 hover:bg-gray-100 transition" data-mode="speak">üé§ Speak</button>
        </div>

        <!-- Audio Section -->
        <div class="text-center my-4">
            <button id="playBtn" class="bg-cyan-500 hover:bg-cyan-600 text-white px-6 py-3 rounded-lg transition">üîä Play Audio</button>
        </div>

        <!-- Listen Mode -->
        <div id="listenMode" class="space-y-4">
            <input type="text" id="answerInput" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none text-lg" placeholder="Type pinyin + tone (e.g., ma1, zhang4)...">
            <button id="checkBtn" class="w-full bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg font-semibold transition">Check Answer</button>
        </div>

        <!-- Multiple Choice Mode -->
        <div id="chooseMode" class="hidden">
            <div class="text-center text-gray-600 mb-4">Which pinyin do you hear?</div>
            <div id="options" class="grid grid-cols-2 gap-3"></div>
        </div>

        <!-- Tone 2 vs 4 Mode -->
        <div id="tone24Mode" class="hidden">
            <div class="text-center text-gray-600 mb-4">Which tone?</div>
            <div id="tone24Options" class="grid grid-cols-2 gap-3"></div>
        </div>

        <!-- Speak Mode -->
        <div id="speakMode" class="hidden text-center">
            <div id="displayPinyin" class="text-6xl font-bold text-blue-600 my-8"></div>
            <button id="micBtn" class="bg-red-500 hover:bg-red-600 text-white px-12 py-6 rounded-full font-semibold text-lg transition">
                üé§ Hold to Speak
            </button>
            <div class="text-gray-500 text-sm mt-4">Hold the button and say the pinyin syllable</div>
            <div id="recognizedText" class="text-blue-600 font-medium mt-4 min-h-[25px]"></div>
        </div>

        <!-- Double Mode -->
        <div id="doubleMode" class="hidden space-y-4">
            <div class="text-center text-gray-600 mb-4">Type both syllables with a space (e.g., ma1 zhang4)</div>
            <input type="text" id="doubleAnswerInput" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none text-lg" placeholder="Type both syllables (e.g., ma1 zhang4)...">
            <button id="doubleCheckBtn" class="w-full bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg font-semibold transition">Check Answer</button>
        </div>

        <!-- Feedback -->
        <div id="feedback" class="text-center font-semibold my-4 min-h-[24px]"></div>

        <!-- Next Button -->
        <button id="nextBtn" class="w-full bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-medium transition mt-4">
            Next Question ‚Üí
        </button>

        <!-- Stats -->
        <div class="flex justify-between text-sm text-gray-600 pt-4 mt-4 border-t border-gray-200">
            <span>Score: <span id="score" class="font-semibold">0</span>/<span id="total" class="font-semibold">0</span></span>
            <span>Accuracy: <span id="percentage" class="font-semibold">0%</span></span>
        </div>
    </div>

    <script>
        // Convert pinyin with tone number to pinyin with tone marks
        function addToneMarks(pinyin, tone) {
            const toneMap = {
                'a': ['ƒÅ', '√°', '«é', '√†'],
                'e': ['ƒì', '√©', 'ƒõ', '√®'],
                'i': ['ƒ´', '√≠', '«ê', '√¨'],
                'o': ['≈ç', '√≥', '«í', '√≤'],
                'u': ['≈´', '√∫', '«î', '√π'],
                '√º': ['«ñ', '«ò', '«ö', '«ú']
            };

            if (tone < 1 || tone > 4) return pinyin;

            // Find which vowel gets the tone mark
            // Rules: a/e get it first, otherwise ou->o, otherwise last vowel
            let idx = -1;
            if (pinyin.includes('a')) idx = pinyin.indexOf('a');
            else if (pinyin.includes('e')) idx = pinyin.indexOf('e');
            else if (pinyin.includes('ou')) idx = pinyin.indexOf('o');
            else {
                // Find last vowel
                for (let i = pinyin.length - 1; i >= 0; i--) {
                    if ('aeiou√º'.includes(pinyin[i])) {
                        idx = i;
                        break;
                    }
                }
            }

            if (idx === -1) return pinyin;

            const vowel = pinyin[idx];
            const toneVowel = toneMap[vowel][tone - 1];
            return pinyin.substring(0, idx) + toneVowel + pinyin.substring(idx + 1);
        }

        const commonSyllables = [
            'ma', 'ba', 'pa', 'fa', 'da', 'ta', 'na', 'la', 'ga', 'ka', 'ha',
            'ji', 'qi', 'xi', 'zhi', 'chi', 'shi', 'ri', 'zi', 'ci', 'si',
            'bo', 'po', 'mo', 'fo', 'de', 'te', 'ne', 'le', 'ge', 'ke', 'he',
            'me', 'bu', 'pu', 'mu', 'fu', 'du', 'tu', 'nu', 'lu', 'gu', 'ku', 'hu',
            'ju', 'qu', 'xu', 'zhu', 'chu', 'shu', 'ru', 'zu', 'cu', 'su',
            'bai', 'pai', 'mai', 'dai', 'tai', 'nai', 'lai', 'gai', 'kai', 'hai',
            'bei', 'pei', 'mei', 'fei', 'dei', 'lei', 'gei', 'hei',
            'bao', 'pao', 'mao', 'dao', 'tao', 'nao', 'lao', 'gao', 'kao', 'hao',
            'dou', 'tou', 'nou', 'lou', 'gou', 'kou', 'hou',
            'ban', 'pan', 'man', 'fan', 'dan', 'tan', 'nan', 'lan', 'gan', 'kan', 'han',
            'ben', 'pen', 'men', 'fen', 'den', 'nen', 'gen', 'ken', 'hen',
            'bang', 'pang', 'mang', 'fang', 'dang', 'tang', 'nang', 'lang', 'gang', 'kang', 'hang',
            'deng', 'teng', 'neng', 'leng', 'geng', 'keng', 'heng',
            'bing', 'ping', 'ming', 'ding', 'ting', 'ning', 'ling',
            'dong', 'tong', 'nong', 'long', 'gong', 'kong', 'hong',
            'jia', 'qia', 'xia', 'jie', 'qie', 'xie', 'jiao', 'qiao', 'xiao',
            'jiu', 'qiu', 'xiu', 'jian', 'qian', 'xian', 'jin', 'qin', 'xin',
            'jiang', 'qiang', 'xiang', 'jing', 'qing', 'xing', 'jiong', 'qiong', 'xiong',
            'zha', 'cha', 'sha', 'zhe', 'che', 'she', 're', 'zhao', 'chao', 'shao', 'rao',
            'zhou', 'chou', 'shou', 'rou', 'zhan', 'chan', 'shan', 'ran',
            'zhen', 'chen', 'shen', 'ren', 'zhang', 'chang', 'shang', 'rang',
            'zheng', 'cheng', 'sheng', 'reng', 'zhong', 'chong', 'rong',
            'za', 'ca', 'sa', 'ze', 'ce', 'se', 'zao', 'cao', 'sao',
            'zou', 'cou', 'sou', 'zan', 'can', 'san', 'zen', 'cen', 'sen',
            'zang', 'cang', 'sang', 'zeng', 'ceng', 'seng', 'zong', 'cong', 'song',
            'yi', 'ya', 'yao', 'you', 'yan', 'yin', 'yang', 'ying', 'yong',
            'wu', 'wa', 'wo', 'wai', 'wei', 'wan', 'wen', 'wang', 'weng',
            'yu', 'yue', 'yuan', 'yun'
        ];

        let currentPinyin = '';
        let currentTone = 1;
        let currentPinyin2 = '';
        let currentTone2 = 1;
        let score = 0;
        let total = 0;
        let answered = false;
        let mode = 'listen';
        let selectedOptionIndex = 0;
        let recognition = null;
        let isRecognizing = false;

        const playBtn = document.getElementById('playBtn');
        const nextBtn = document.getElementById('nextBtn');
        const feedback = document.getElementById('feedback');
        const answerInput = document.getElementById('answerInput');
        const checkBtn = document.getElementById('checkBtn');
        const listenMode = document.getElementById('listenMode');
        const chooseMode = document.getElementById('chooseMode');
        const tone24Mode = document.getElementById('tone24Mode');
        const speakMode = document.getElementById('speakMode');
        const doubleMode = document.getElementById('doubleMode');
        const doubleAnswerInput = document.getElementById('doubleAnswerInput');
        const doubleCheckBtn = document.getElementById('doubleCheckBtn');
        const micBtn = document.getElementById('micBtn');
        const displayPinyin = document.getElementById('displayPinyin');
        const recognizedText = document.getElementById('recognizedText');

        function generateQuestion() {
            currentPinyin = commonSyllables[Math.floor(Math.random() * commonSyllables.length)];

            if (mode === 'tone24') {
                // Only generate tone 2 or 4
                currentTone = Math.random() < 0.5 ? 2 : 4;
            } else {
                currentTone = Math.floor(Math.random() * 4) + 1;
            }

            // Generate second syllable for double mode
            if (mode === 'double') {
                currentPinyin2 = commonSyllables[Math.floor(Math.random() * commonSyllables.length)];
                currentTone2 = Math.floor(Math.random() * 4) + 1;
                // Make sure they're different
                while (currentPinyin2 === currentPinyin && currentTone2 === currentTone) {
                    currentPinyin2 = commonSyllables[Math.floor(Math.random() * commonSyllables.length)];
                    currentTone2 = Math.floor(Math.random() * 4) + 1;
                }
            }

            answered = false;
            feedback.textContent = '';
            feedback.className = 'feedback';
            answerInput.value = '';
            if (doubleAnswerInput) doubleAnswerInput.value = '';

            if (mode === 'choose') {
                generateOptions();
            } else if (mode === 'tone24') {
                generateTone24Options();
            } else if (mode === 'speak') {
                displayPinyin.textContent = addToneMarks(currentPinyin, currentTone);
                recognizedText.textContent = '';
            } else if (mode === 'double') {
                setTimeout(() => doubleAnswerInput.focus(), 100);
            } else {
                // Focus input in listen mode
                setTimeout(() => answerInput.focus(), 100);
            }
        }

        function generateTone24Options() {
            const options = document.getElementById('tone24Options');
            options.innerHTML = '';

            const tones = [2, 4];

            tones.forEach((tone, index) => {
                const btn = document.createElement('button');
                btn.className = 'option-btn px-4 py-3 text-3xl bg-gray-100 hover:bg-gray-200 rounded-lg border-2 border-gray-300 transition';
                btn.textContent = addToneMarks(currentPinyin, tone);
                btn.dataset.tone = tone;
                btn.dataset.index = index;
                btn.onclick = () => checkAnswerChoice(tone, btn);
                options.appendChild(btn);
            });

            // Reset and select first option
            selectedOptionIndex = 0;
            updateSelectedOption();
        }

        function generateOptions() {
            const options = document.getElementById('options');
            options.innerHTML = '';

            // All 4 tones in order
            const tones = [1, 2, 3, 4];

            tones.forEach((tone, index) => {
                const btn = document.createElement('button');
                btn.className = 'option-btn px-4 py-3 text-3xl bg-gray-100 hover:bg-gray-200 rounded-lg border-2 border-gray-300 transition';
                btn.textContent = addToneMarks(currentPinyin, tone);
                btn.dataset.tone = tone;
                btn.dataset.index = index;
                btn.onclick = () => checkAnswerChoice(tone, btn);
                options.appendChild(btn);
            });

            // Reset and select first option
            selectedOptionIndex = 0;
            updateSelectedOption();
        }

        function updateSelectedOption() {
            const buttons = document.querySelectorAll('.option-btn');
            buttons.forEach((btn, idx) => {
                if (idx === selectedOptionIndex) {
                    btn.classList.add('bg-blue-100', 'border-blue-500');
                    btn.classList.remove('bg-gray-100');
                } else {
                    btn.classList.remove('bg-blue-100', 'border-blue-500');
                    btn.classList.add('bg-gray-100');
                }
            });
        }

        function selectOption(index) {
            const buttons = document.querySelectorAll('.option-btn');
            if (index >= 0 && index < buttons.length) {
                selectedOptionIndex = index;
                updateSelectedOption();
            }
        }

        function activateSelectedOption() {
            const buttons = document.querySelectorAll('.option-btn');
            if (selectedOptionIndex >= 0 && selectedOptionIndex < buttons.length) {
                buttons[selectedOptionIndex].click();
            }
        }

        function playAudio() {
            playBtn.classList.add('playing');

            if (mode === 'double') {
                // Play two syllables in sequence
                const audioUrl1 = `https://www.purpleculture.net/mp3/${currentPinyin}${currentTone}.mp3`;
                const audioUrl2 = `https://www.purpleculture.net/mp3/${currentPinyin2}${currentTone2}.mp3`;

                const audio1 = new Audio(audioUrl1);

                audio1.play().catch(err => {
                    console.error('Audio playback failed:', err);
                    playBtn.classList.remove('playing');
                });

                audio1.onended = () => {
                    // Play second syllable after first ends
                    setTimeout(() => {
                        const audio2 = new Audio(audioUrl2);
                        audio2.play().catch(err => {
                            console.error('Audio playback failed:', err);
                            playBtn.classList.remove('playing');
                        });

                        audio2.onended = () => {
                            playBtn.classList.remove('playing');
                        };
                    }, 300); // 300ms pause between syllables
                };
            } else {
                // Single syllable playback
                const audioUrl = `https://www.purpleculture.net/mp3/${currentPinyin}${currentTone}.mp3`;
                const audio = new Audio(audioUrl);

                audio.play().catch(err => {
                    console.error('Audio playback failed:', err);
                    playBtn.classList.remove('playing');
                });

                audio.onended = () => {
                    playBtn.classList.remove('playing');
                };
            }
        }

        function checkAnswer(answer, btnElement = null) {
            if (!answer.trim()) return;

            // Parse input like "ma1" or "zhang4"
            const match = answer.toLowerCase().trim().match(/^([a-z]+)([1-4])$/);
            const correct = match && match[1] === currentPinyin && parseInt(match[2]) === currentTone;

            if (correct) {
                if (!answered) {
                    answered = true;
                    total++;
                    score++;
                }
                feedback.textContent = `‚úì Correct! (${currentPinyin}${currentTone})`;
                feedback.className = 'text-center font-semibold my-4 min-h-[24px] text-green-600';

                // Auto-advance to next question after correct answer
                setTimeout(() => {
                    generateQuestion();
                    playAudio();
                }, 800);
            } else {
                if (!answered) {
                    answered = true;
                    total++;
                }
                feedback.textContent = `‚úó Wrong. The answer is: ${currentPinyin}${currentTone}. Try again!`;
                feedback.className = 'text-center font-semibold my-4 min-h-[24px] text-red-600';
                // Clear immediately without delay
                setTimeout(() => {
                    answerInput.value = '';
                    answerInput.focus();
                }, 0);
            }

            updateStats();
        }

        function checkAnswerChoice(tone, btnElement) {
            if (answered) return;

            answered = true;
            total++;

            const correct = tone === currentTone;
            const correctPinyinWithTone = addToneMarks(currentPinyin, currentTone);

            if (correct) {
                score++;
                feedback.textContent = `‚úì Correct! (${correctPinyinWithTone})`;
                feedback.className = 'text-center font-semibold my-4 min-h-[24px] text-green-600';
                btnElement.classList.add('bg-green-500', 'text-white');
                btnElement.classList.remove('bg-gray-100', 'hover:bg-gray-200');

                // Auto-advance to next question
                setTimeout(() => {
                    generateQuestion();
                    playAudio();
                }, 800);
            } else {
                feedback.textContent = `‚úó Wrong. The answer was: ${correctPinyinWithTone}`;
                feedback.className = 'text-center font-semibold my-4 min-h-[24px] text-red-600';
                btnElement.classList.add('bg-red-500', 'text-white');
                btnElement.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                document.querySelectorAll('.option-btn').forEach(btn => {
                    if (parseInt(btn.dataset.tone) === currentTone) {
                        btn.classList.add('bg-green-500', 'text-white');
                        btn.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                    }
                });

                // Auto-advance on wrong answer for multiple choice modes
                if (mode === 'choose' || mode === 'tone24') {
                    setTimeout(() => {
                        generateQuestion();
                        playAudio();
                    }, 1200);
                }
            }

            updateStats();

            document.querySelectorAll('.option-btn').forEach(btn => {
                btn.disabled = true;
                btn.classList.add('cursor-not-allowed');
            });
        }

        function updateStats() {
            document.getElementById('score').textContent = score;
            document.getElementById('total').textContent = total;
            const percentage = total > 0 ? Math.round((score / total) * 100) : 0;
            document.getElementById('percentage').textContent = percentage;
        }

        function checkDoubleAnswer(answer) {
            if (!answer.trim()) return;

            // Parse input like "ma1 zhang4" or "ma1,zhang4"
            const parts = answer.toLowerCase().trim().split(/[\s,]+/);

            if (parts.length !== 2) {
                feedback.textContent = '‚ö† Please type two syllables separated by a space';
                feedback.className = 'text-center font-semibold my-4 min-h-[24px] text-yellow-600';
                return;
            }

            const match1 = parts[0].match(/^([a-z]+)([1-4])$/);
            const match2 = parts[1].match(/^([a-z]+)([1-4])$/);

            const correct1 = match1 && match1[1] === currentPinyin && parseInt(match1[2]) === currentTone;
            const correct2 = match2 && match2[1] === currentPinyin2 && parseInt(match2[2]) === currentTone2;
            const correct = correct1 && correct2;

            if (correct) {
                if (!answered) {
                    answered = true;
                    total++;
                    score++;
                }
                feedback.textContent = `‚úì Correct! (${currentPinyin}${currentTone} ${currentPinyin2}${currentTone2})`;
                feedback.className = 'text-center font-semibold my-4 min-h-[24px] text-green-600';

                // Auto-advance to next question after correct answer
                setTimeout(() => {
                    generateQuestion();
                    playAudio();
                }, 800);
            } else {
                if (!answered) {
                    answered = true;
                    total++;
                }

                let errorMsg = '‚úó Wrong. ';
                if (!correct1 && !correct2) {
                    errorMsg += `Both wrong. `;
                } else if (!correct1) {
                    errorMsg += `First syllable wrong. `;
                } else {
                    errorMsg += `Second syllable wrong. `;
                }
                errorMsg += `Answer: ${currentPinyin}${currentTone} ${currentPinyin2}${currentTone2}`;

                feedback.textContent = errorMsg;
                feedback.className = 'text-center font-semibold my-4 min-h-[24px] text-red-600';

                setTimeout(() => {
                    doubleAnswerInput.value = '';
                    doubleAnswerInput.focus();
                }, 0);
            }

            updateStats();
        }

        playBtn.addEventListener('click', playAudio);
        nextBtn.addEventListener('click', () => {
            generateQuestion();
            playAudio();
        });

        checkBtn.addEventListener('click', () => {
            checkAnswer(answerInput.value);
        });

        answerInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                checkAnswer(answerInput.value);
            } else if (e.key === ' ') {
                e.preventDefault();
                playAudio();
            }
        });

        doubleCheckBtn.addEventListener('click', () => {
            checkDoubleAnswer(doubleAnswerInput.value);
        });

        doubleAnswerInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                checkDoubleAnswer(doubleAnswerInput.value);
            } else if (e.key === ' ' && mode === 'double' && doubleAnswerInput.value.trim() === '') {
                // Only replay if input is empty (spacebar at start)
                e.preventDefault();
                playAudio();
            }
        });

        // Global keyboard listeners for multiple choice modes
        document.addEventListener('keydown', (e) => {
            if ((mode === 'choose' || mode === 'tone24') && !answered) {
                if (e.key === ' ') {
                    e.preventDefault();
                    playAudio();
                } else if (e.key === 'h') {
                    e.preventDefault();
                    if (mode === 'tone24') {
                        // For tone24: just 2 options side by side
                        if (selectedOptionIndex === 1) selectOption(0);
                    } else {
                        // Move left (in grid: 0,1 top row, 2,3 bottom row)
                        if (selectedOptionIndex === 1) selectOption(0);
                        else if (selectedOptionIndex === 3) selectOption(2);
                    }
                } else if (e.key === 'l') {
                    e.preventDefault();
                    if (mode === 'tone24') {
                        if (selectedOptionIndex === 0) selectOption(1);
                    } else {
                        // Move right
                        if (selectedOptionIndex === 0) selectOption(1);
                        else if (selectedOptionIndex === 2) selectOption(3);
                    }
                } else if (e.key === 'k') {
                    e.preventDefault();
                    if (mode === 'choose') {
                        // Move up
                        if (selectedOptionIndex === 2) selectOption(0);
                        else if (selectedOptionIndex === 3) selectOption(1);
                    }
                } else if (e.key === 'j') {
                    e.preventDefault();
                    if (mode === 'choose') {
                        // Move down
                        if (selectedOptionIndex === 0) selectOption(2);
                        else if (selectedOptionIndex === 1) selectOption(3);
                    }
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    activateSelectedOption();
                } else if (e.key >= '1' && e.key <= '4') {
                    e.preventDefault();
                    const index = parseInt(e.key) - 1;
                    const buttons = document.querySelectorAll('.option-btn');
                    if (index < buttons.length) {
                        selectOption(index);
                        activateSelectedOption();
                    }
                } else if (mode === 'tone24' && (e.key === '2' || e.key === '4')) {
                    e.preventDefault();
                    // Direct tone selection for tone24 mode
                    const buttons = document.querySelectorAll('.option-btn');
                    buttons.forEach((btn, idx) => {
                        if (btn.dataset.tone === e.key) {
                            selectOption(idx);
                            activateSelectedOption();
                        }
                    });
                }
            }
        });

        // Speech Recognition - Rewritten from scratch
        function initSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

            if (!SpeechRecognition) {
                alert('Speech recognition not supported. Use Chrome or Edge browser.');
                return null;
            }

            const rec = new SpeechRecognition();
            rec.lang = 'zh-CN';
            rec.continuous = false;
            rec.interimResults = false;

            rec.onstart = () => {
                isRecognizing = true;
                if (micBtn) {
                    micBtn.style.background = '#28a745';
                    micBtn.textContent = 'üé§ Listening...';
                }
                if (recognizedText) {
                    recognizedText.textContent = 'Listening...';
                }
            };

            rec.onresult = (event) => {
                const result = event.results[0][0];
                const transcript = result.transcript.trim();
                const confidence = Math.round(result.confidence * 100);

                if (recognizedText) {
                    recognizedText.textContent = `Heard: "${transcript}" (${confidence}%)`;
                }

                checkSpeechAnswer(transcript);
            };

            rec.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                isRecognizing = false;

                if (micBtn) {
                    micBtn.style.background = '#dc3545';
                    micBtn.textContent = 'üé§ Hold to Speak';
                }

                if (recognizedText) {
                    if (event.error === 'no-speech') {
                        recognizedText.textContent = 'No speech detected. Try again.';
                    } else if (event.error === 'audio-capture') {
                        recognizedText.textContent = 'No microphone found.';
                    } else if (event.error === 'not-allowed') {
                        recognizedText.textContent = 'Microphone permission denied.';
                    } else {
                        recognizedText.textContent = `Error: ${event.error}`;
                    }
                }
            };

            rec.onend = () => {
                isRecognizing = false;
                if (micBtn) {
                    micBtn.style.background = '#dc3545';
                    micBtn.textContent = 'üé§ Hold to Speak';
                }
            };

            return rec;
        }

        function checkSpeechAnswer(transcript) {
            if (answered) return;

            const targetPinyin = addToneMarks(currentPinyin, currentTone);

            // Normalize both strings for comparison
            const normalizedTarget = targetPinyin.toLowerCase().replace(/\s/g, '');
            const normalizedTranscript = transcript.toLowerCase().replace(/\s/g, '');

            // Check if speech matches target
            const correct = normalizedTranscript === normalizedTarget ||
                           normalizedTranscript.includes(normalizedTarget);

            answered = true;
            total++;

            if (correct) {
                score++;
                feedback.textContent = `‚úì Correct! You said "${transcript}"`;
                feedback.className = 'feedback correct';

                updateStats();

                setTimeout(() => {
                    generateQuestion();
                }, 1500);
            } else {
                feedback.textContent = `‚úó Wrong. Expected: ${targetPinyin}, You said: "${transcript}"`;
                feedback.className = 'feedback incorrect';

                updateStats();

                // Allow retry
                setTimeout(() => {
                    answered = false;
                    total--;
                    feedback.textContent = '';
                    if (recognizedText) recognizedText.textContent = '';
                }, 2000);
            }
        }

        function startListening() {
            if (mode !== 'speak' || isRecognizing) return;

            if (!recognition) {
                recognition = initSpeechRecognition();
            }

            if (recognition) {
                try {
                    recognition.start();
                } catch (e) {
                    console.error('Failed to start recognition:', e);
                }
            }
        }

        function stopListening() {
            if (recognition && isRecognizing) {
                try {
                    recognition.stop();
                } catch (e) {
                    console.error('Failed to stop recognition:', e);
                }
            }
        }

        // Microphone button controls
        if (micBtn) {
            // Mouse events
            micBtn.addEventListener('mousedown', startListening);
            micBtn.addEventListener('mouseup', stopListening);
            micBtn.addEventListener('mouseleave', stopListening);

            // Touch events for mobile
            micBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                startListening();
            });

            micBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                stopListening();
            });
        }

        // Mode selector
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // Remove active state from all buttons
                document.querySelectorAll('.mode-btn').forEach(b => {
                    b.classList.remove('bg-blue-500', 'text-white', 'border-blue-500');
                });

                // Add active state to clicked button
                btn.classList.add('bg-blue-500', 'text-white', 'border-blue-500');

                mode = btn.dataset.mode;

                // Hide all modes
                listenMode.classList.add('hidden');
                chooseMode.classList.add('hidden');
                tone24Mode.classList.add('hidden');
                speakMode.classList.add('hidden');
                doubleMode.classList.add('hidden');

                // Show selected mode
                if (mode === 'listen') {
                    listenMode.classList.remove('hidden');
                } else if (mode === 'choose') {
                    chooseMode.classList.remove('hidden');
                } else if (mode === 'tone24') {
                    tone24Mode.classList.remove('hidden');
                } else if (mode === 'speak') {
                    speakMode.classList.remove('hidden');
                } else if (mode === 'double') {
                    doubleMode.classList.remove('hidden');
                }

                generateQuestion();
            });
        });

        // Initialize first mode button as active
        const firstModeBtn = document.querySelector('.mode-btn[data-mode="listen"]');
        if (firstModeBtn) {
            firstModeBtn.classList.add('bg-blue-500', 'text-white', 'border-blue-500');
        }

        // Start first question
        generateQuestion();
        playAudio();
    </script>
</body>
</html>