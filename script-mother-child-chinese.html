<!DOCTYPE html>
<html lang="zh-CN" translate="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google" content="notranslate">
    <title>Script: Mother-Child Chinese Learning Dialogue</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="css/common.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500&display=swap" rel="stylesheet">
    <script src="js/command-palette.js"></script>
    <style>
        body {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 300;
            background: #f3f4f6;
        }
        .script-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }
        .line {
            display: flex;
            gap: 1rem;
            padding: 1rem;
            margin-bottom: 0.5rem;
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            align-items: flex-start;
        }
        .line:hover {
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        .line-content {
            flex: 1;
        }
        .line-pinyin {
            font-size: 0.875rem;
            color: #6366f1;
            margin-top: 0.25rem;
        }
        .line-english {
            font-size: 0.875rem;
            color: #6b7280;
            font-style: italic;
            margin-top: 0.25rem;
        }
        .speaker {
            font-weight: 500;
            min-width: 3.5rem;
            color: #6366f1;
            flex-shrink: 0;
        }
        .speaker.child {
            color: #10b981;
        }
        .chinese {
            font-size: 1.25rem;
            line-height: 1.8;
            flex: 1;
        }
        .grammar-refs {
            font-size: 0.75rem;
            color: #9ca3af;
            margin-left: auto;
            flex-shrink: 0;
        }
        .play-btn {
            background: #e5e7eb;
            border: none;
            border-radius: 0.375rem;
            padding: 0.5rem;
            cursor: pointer;
            font-size: 1rem;
            flex-shrink: 0;
        }
        .play-btn:hover {
            background: #d1d5db;
        }
        .play-btn.playing {
            background: #fecaca;
        }
        .controls {
            display: flex;
            gap: 0.75rem;
            justify-content: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        .control-btn {
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 0.75rem 1.25rem;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.875rem;
        }
        .control-btn:hover {
            background: #f9fafb;
        }
        .control-btn.active {
            background: #6366f1;
            color: white;
            border-color: #6366f1;
        }
        .hidden-text .chinese,
        .hidden-text .line-pinyin,
        .hidden-text .line-english {
            color: transparent;
            background: #e5e7eb;
            border-radius: 0.25rem;
            user-select: none;
        }
        .hidden-text .line:hover .chinese,
        .hidden-text .line:hover .line-pinyin,
        .hidden-text .line:hover .line-english {
            color: inherit;
            background: transparent;
        }
        .hidden-text .line:hover .line-pinyin {
            color: #6366f1;
        }
        .hidden-text .line:hover .line-english {
            color: #6b7280;
        }
        h1 {
            text-align: center;
            margin-bottom: 0.5rem;
            font-weight: 400;
        }
        .subtitle {
            text-align: center;
            color: #6b7280;
            margin-bottom: 1.5rem;
            font-size: 0.875rem;
        }
        .home-btn {
            position: fixed;
            top: 1rem;
            left: 1rem;
            background: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            text-decoration: none;
            color: #374151;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            font-size: 0.875rem;
            z-index: 100;
        }
        .home-btn:hover {
            background: #f9fafb;
        }
        /* Write mode styles */
        .write-mode-container {
            display: none;
            margin-top: 1rem;
        }
        .write-mode-container.active {
            display: block;
        }
        .write-prompt {
            text-align: center;
            padding: 2rem;
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
        }
        .write-prompt .speaker-label {
            font-size: 1rem;
            color: #6366f1;
            margin-bottom: 0.5rem;
        }
        .write-prompt .speaker-label.child {
            color: #10b981;
        }
        .write-prompt .hint-text {
            font-size: 0.875rem;
            color: #9ca3af;
            margin-top: 0.5rem;
        }
        .write-input-area {
            width: 100%;
            padding: 1rem;
            font-size: 1.25rem;
            font-family: inherit;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            min-height: 100px;
            resize: vertical;
        }
        .write-input-area:focus {
            outline: none;
            border-color: #6366f1;
        }
        .write-input-area.correct {
            border-color: #10b981;
            background: #f0fdf4;
        }
        .write-input-area.incorrect {
            border-color: #ef4444;
            background: #fef2f2;
        }
        .write-controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1rem;
        }
        .write-feedback {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 0.5rem;
            display: none;
        }
        .write-feedback.show {
            display: block;
        }
        .write-feedback.correct {
            background: #f0fdf4;
            border: 1px solid #10b981;
        }
        .write-feedback.incorrect {
            background: #fef2f2;
            border: 1px solid #ef4444;
        }
        .diff-display {
            font-size: 1.25rem;
            line-height: 2;
        }
        .diff-correct {
            color: #10b981;
        }
        .diff-wrong {
            color: #ef4444;
            text-decoration: line-through;
        }
        .diff-missing {
            color: #6366f1;
            background: #eef2ff;
            padding: 0 0.25rem;
            border-radius: 0.25rem;
        }
        .progress-bar {
            display: flex;
            gap: 0.25rem;
            justify-content: center;
            margin-bottom: 1rem;
        }
        .progress-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e5e7eb;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .progress-dot:hover {
            transform: scale(1.3);
        }
        .progress-dot.current {
            background: #6366f1;
        }
        .progress-dot.correct {
            background: #10b981;
        }
        .progress-dot.incorrect {
            background: #ef4444;
        }
        .line-counter {
            text-align: center;
            font-size: 0.75rem;
            color: #9ca3af;
            margin-bottom: 0.5rem;
        }
        .answer-details .grammar-ref {
            font-size: 0.75rem;
            color: #9ca3af;
            margin-top: 0.75rem;
        }
        .settings-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }
        .settings-row label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #6b7280;
            cursor: pointer;
        }
        .settings-row input[type="checkbox"] {
            cursor: pointer;
        }
        .score-display {
            text-align: center;
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 1rem;
        }
        .answer-details {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #fecaca;
        }
        .answer-details .label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #9ca3af;
            margin-bottom: 0.25rem;
        }
        .answer-details .pinyin {
            font-size: 1rem;
            color: #6366f1;
            margin-bottom: 0.75rem;
        }
        .answer-details .english {
            font-size: 0.95rem;
            color: #374151;
            font-style: italic;
        }
        .answer-details .correct-answer {
            font-size: 1.25rem;
            margin-bottom: 0.75rem;
            color: #1f2937;
        }
        .hotkey-hint {
            font-size: 0.75rem;
            color: #9ca3af;
            margin-top: 0.5rem;
        }
        .context-line {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
            text-align: left;
        }
        .context-line .context-speaker {
            font-size: 0.75rem;
            color: #6366f1;
            margin-bottom: 0.25rem;
        }
        .context-line .context-speaker.mother {
            color: #6366f1;
        }
        .context-line .context-speaker.child {
            color: #10b981;
        }
        .context-line .context-text {
            font-size: 1rem;
            color: #374151;
        }
        .context-line .context-english {
            font-size: 0.8rem;
            color: #9ca3af;
            font-style: italic;
            margin-top: 0.25rem;
        }
        .context-play-btn {
            background: #e5e7eb;
            border: none;
            border-radius: 0.25rem;
            padding: 0.25rem 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
            margin-left: 0.5rem;
        }
        .prompt-hint {
            font-size: 1.1rem;
            color: #374151;
            margin: 1rem 0;
            padding: 0.75rem;
            background: #f3f4f6;
            border-radius: 0.5rem;
        }
        .prompt-hint.english {
            font-style: italic;
        }
        .prompt-hint.pinyin {
            color: #6366f1;
        }
        .speak-mode-controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1rem;
        }
        .speak-mode-answer {
            margin-top: 1rem;
            padding: 1rem;
            background: #f0fdf4;
            border-radius: 0.5rem;
            display: none;
        }
        .speak-mode-answer.show {
            display: block;
        }
        .speak-mode-answer .chinese {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
        }
        .speak-mode-answer .pinyin {
            color: #6366f1;
            font-size: 0.95rem;
        }
        /* Live feedback display */
        .live-feedback {
            font-size: 1.5rem;
            line-height: 2;
            padding: 1rem;
            background: white;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            min-height: 3rem;
            border: 2px solid #e5e7eb;
        }
        .live-feedback .char-correct {
            color: #10b981;
        }
        .live-feedback .char-wrong {
            color: #ef4444;
            text-decoration: underline;
        }
        .live-feedback .char-expected {
            color: #d1d5db;
        }
        .live-feedback .char-punct {
            color: #e5e7eb;
            font-size: 0.9em;
        }
        .live-feedback .char-punct-typed {
            color: #9ca3af;
            font-size: 0.9em;
        }
        .live-feedback .char-skipped {
            color: #fbbf24;
            text-decoration: underline dotted;
        }
        .live-feedback .char-cursor {
            border-left: 2px solid #6366f1;
            animation: blink 1s infinite;
            margin-left: 1px;
        }
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        .live-feedback.complete {
            border-color: #10b981;
            background: #f0fdf4;
        }
        .char-count {
            font-size: 0.75rem;
            color: #9ca3af;
            text-align: right;
            margin-top: 0.25rem;
        }
        kbd {
            background: #e5e7eb;
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            font-family: inherit;
            font-size: 0.75rem;
        }
    </style>
</head>
<body>
    <a href="home.html" class="home-btn">‚Üê Home</a>

    <div class="script-container">
        <h1>Learning Chinese: Mother-Child Dialogue</h1>
        <p class="subtitle">Grammar points from Lessons 8-11</p>

        <div class="controls">
            <button class="control-btn" id="readModeBtn" onclick="setMode('read')">Read Mode</button>
            <button class="control-btn" id="writeModeBtn" onclick="setMode('write')">Write Mode</button>
            <span style="border-left: 1px solid #d1d5db; margin: 0 0.5rem;"></span>
            <button class="control-btn" onclick="playAll()">Play All</button>
            <button class="control-btn" onclick="stopAudio()">Stop</button>
            <button class="control-btn" id="hideBtn" onclick="toggleHide()">Hide Text</button>
            <button class="control-btn" onclick="setSpeed(0.8)">0.8x</button>
            <button class="control-btn active" onclick="setSpeed(1.0)">1.0x</button>
            <button class="control-btn" onclick="setSpeed(1.2)">1.2x</button>
        </div>

        <div id="readMode">
            <div id="scriptLines"></div>
        </div>

        <div id="writeMode" class="write-mode-container">
            <div class="progress-bar" id="progressBar"></div>
            <div class="line-counter" id="lineCounter">Line 1 of 12</div>
            <div class="score-display" id="scoreDisplay">Score: 0/0</div>

            <div class="settings-row">
                <strong>Role:</strong>
                <label><input type="radio" name="role" value="both" checked onchange="setRole('both')"> Both</label>
                <label><input type="radio" name="role" value="child" onchange="setRole('child')"> Child only</label>
                <label><input type="radio" name="role" value="mother" onchange="setRole('mother')"> Mother only</label>
            </div>
            <div class="settings-row">
                <strong>Mode:</strong>
                <label><input type="radio" name="practiceMode" value="audio" checked onchange="setPracticeMode('audio')"> Audio ‚Üí Type</label>
                <label><input type="radio" name="practiceMode" value="english" onchange="setPracticeMode('english')"> English ‚Üí Type</label>
                <label><input type="radio" name="practiceMode" value="pinyin" onchange="setPracticeMode('pinyin')"> With Pinyin</label>
                <label><input type="radio" name="practiceMode" value="speak" onchange="setPracticeMode('speak')"> Listen & Speak</label>
            </div>
            <div class="settings-row">
                <label><input type="checkbox" id="autoPlayCheck" checked> Auto-play audio</label>
                <label><input type="checkbox" id="autoAdvanceCheck"> Auto-advance on correct</label>
            </div>

            <div id="contextLine" class="context-line" style="display: none;">
                <span class="context-speaker" id="contextSpeaker"></span>
                <button class="context-play-btn" onclick="playContextLine()">üîä</button>
                <div class="context-text" id="contextText"></div>
                <div class="context-english" id="contextEnglish"></div>
            </div>

            <div class="write-prompt" id="writePrompt">
                <div class="speaker-label" id="writeSpeaker"></div>
                <button class="play-btn" onclick="playCurrentLine()" style="font-size: 1.5rem; padding: 0.75rem 1rem;">üîä Play Audio</button>
                <div id="promptHint" class="prompt-hint" style="display: none;"></div>
                <div class="hint-text" id="hintText">Listen and type the Chinese characters</div>
                <div class="hotkey-hint"><kbd>;</kbd> play ¬∑ <kbd>Enter</kbd> check ¬∑ <kbd>Ctrl+‚Üê/‚Üí</kbd> prev/next</div>
            </div>

            <!-- Type mode input -->
            <div id="typeSection">
                <div class="live-feedback" id="liveFeedback"></div>
                <div class="char-count" id="charCount">0 / 0</div>
                <textarea class="write-input-area" id="writeInput" placeholder="Type Chinese characters here..." oninput="onInputChange()"></textarea>
            </div>

            <!-- Speak mode section -->
            <div id="speakSection" style="display: none;">
                <div class="speak-mode-controls">
                    <button class="control-btn" onclick="playCurrentLine()">üîä Play Again</button>
                    <button class="control-btn" onclick="showSpeakAnswer()">Show Answer</button>
                    <button class="control-btn" onclick="nextWriteLine()">Next ‚Üí</button>
                </div>
                <div id="speakAnswer" class="speak-mode-answer">
                    <div class="chinese" id="speakChinese"></div>
                    <div class="pinyin" id="speakPinyin"></div>
                </div>
            </div>

            <div class="write-controls">
                <button class="control-btn" onclick="prevWriteLine()">‚Üê Prev</button>
                <button class="control-btn" onclick="checkWriteAnswer()">Check (Enter)</button>
                <button class="control-btn" onclick="showWriteAnswer()">Show Answer</button>
                <button class="control-btn" onclick="nextWriteLine()">Next ‚Üí</button>
                <button class="control-btn" onclick="restartWrite()">Restart</button>
            </div>

            <div class="write-feedback" id="writeFeedback">
                <div class="diff-display" id="diffDisplay"></div>
            </div>
        </div>
    </div>

    <script>
        const script = [
            { speaker: 'Â¶àÂ¶à', text: '‰Ω†Âú®Âπ≤ÂòõÔºü', pinyin: 'N«ê z√†i g√†n ma?', english: 'What are you doing?', refs: '' },
            { speaker: 'Â≠©Â≠ê', text: 'ÊàëÂ∞±Âú®Èöè‰æøÂÜôÂÜôÊ±âÂ≠óÔºåÈÉΩÊòØÂ∞èÊó∂ÂÄôÂú®‰∏≠ÊñáÂ≠¶Ê†°Â≠¶ÁöÑ„ÄÇÊàëÂèØËÉΩ‰ºöË∂ÅÊöëÂÅáÁöÑÊú∫‰ºö‰∏ä‰∏ÄÈó®‰∏≠ÊñáËØæ„ÄÇ', pinyin: 'W«í ji√π z√†i su√≠bi√†n xiƒõxie H√†nz√¨, d≈çu sh√¨ xi«éosh√≠hou z√†i Zh≈çngw√©n xu√©xi√†o xu√© de. W«í kƒõn√©ng hu√¨ ch√®n sh«îji√† de jƒ´hu√¨ sh√†ng yƒ´ m√©n Zh≈çngw√©n k√®.', english: "I'm just casually writing some Chinese characters, all learned from Chinese school when I was little. I might take the opportunity during summer break to take a Chinese class.", refs: 'L9-6, L9-8' },
            { speaker: 'Â¶àÂ¶à', text: '‰Ω†‰∏çÊòØ‰ªéÂ∞èÂ∞±‰∏çÂñúÊ¨¢Âéª‰∏≠ÊñáÂ≠¶Ê†°ÂêóÔºüÁé∞Âú®ÊÄé‰πàÊääÂ≠¶‰∏≠ÊñáÁúãÂæóËøô‰πàÈáçË¶ÅÔºü', pinyin: 'N«ê b√∫ sh√¨ c√≥ngxi«éo ji√π b√π x«êhuan q√π Zh≈çngw√©n xu√©xi√†o ma? Xi√†nz√†i zƒõnme b«é xu√© Zh≈çngw√©n k√†n de zh√®me zh√≤ngy√†o?', english: "Didn't you dislike going to Chinese school since you were little? How come now you consider learning Chinese so important?", refs: 'L8-1' },
            { speaker: 'Â≠©Â≠ê', text: 'Âõ†‰∏∫ÊàëË∂äÂ≠¶Ë∂äËßâÂæóÊúâÊÑèÊÄùÔºåË∑ü‰ª•ÂâçÁúüÁöÑ‰∏ç‰∏ÄÊ†∑‰∫Ü„ÄÇ', pinyin: 'Yƒ´nw√®i w«í yu√® xu√© yu√® ju√©de y«íu y√¨si, gƒìn y«êqi√°n zhƒìn de b√π y√≠y√†ng le.', english: "Because the more I study, the more interesting I find it. It's really different from before.", refs: 'L9-1' },
            { speaker: 'Â¶àÂ¶à', text: 'ÁúãÂà∞‰Ω†Ëøô‰πàÂä™ÂäõÔºåÊàëÊÉ≥Ëµ∑Êù•ËøòËßâÂæó‰ª•ÂâçÂØπ‰Ω†Â§™‰∏•ËÇÉ‰∫Ü„ÄÇÊúâÊó∂Áà∏Â¶à‰πüËÆ∏ÈÄºÂæóÂ§™Á¥ßÔºå‰ΩøÊàë‰ª¨ÁöÑÂÖ≥Á≥ªÂæàÁ¥ßÂº†„ÄÇ', pinyin: 'K√†nd√†o n«ê zh√®me n«îl√¨, w«í xi«éng q«êl√°i h√°i ju√©de y«êqi√°n du√¨ n«ê t√†i y√°ns√π le. Y«íush√≠ b√†mƒÅ yƒõx«î bƒ´ de t√†i j«ên, sh«ê w«ímen de guƒÅnxi hƒõn j«ênzhƒÅng.', english: "Seeing you work so hard, I think back and feel I was too strict with you before. Sometimes mom and dad perhaps pushed too hard, making our relationship tense.", refs: 'L10-4, L10-3' },
            { speaker: 'Â≠©Â≠ê', text: 'ÂÖ∂ÂÆûÔºå‰∏éÂÖ∂ËØ¥ÊòØ‰Ω†‰ª¨ÈÄºÊàëÔºå‰∏çÂ¶ÇËØ¥ÊòØÊàëÂ∞èÊó∂ÂÄô‰∏çÊáÇÂ≠¶‰∏≠ÊñáÁöÑÊÑè‰πâ„ÄÇ', pinyin: 'Q√≠sh√≠, y«îq√≠ shu≈ç sh√¨ n«êmen bƒ´ w«í, b√πr√∫ shu≈ç sh√¨ w«í xi«éosh√≠hou b√π d«íng xu√© Zh≈çngw√©n de y√¨y√¨.', english: "Actually, rather than saying you pushed me, it's better to say I didn't understand the meaning of learning Chinese when I was young.", refs: 'L11-6' },
            { speaker: 'Â¶àÂ¶à', text: 'Ê≤°ÂÖ≥Á≥ªÔºå‰Ω†Âè™Ë¶ÅÁé∞Âú®ÊÉ≥Â≠¶Â∞±Â•Ω„ÄÇÊàëËßâÂæóÊâÄÊúâÁöÑÂçéË£îÂ≠©Â≠êÈÉΩÂ∫îËØ•Â≠¶‰∏≠Êñá„ÄÇ', pinyin: 'M√©i guƒÅnxi, n«ê zh«êy√†o xi√†nz√†i xi«éng xu√© ji√π h«éo. W«í ju√©de su«íy«íu de Hu√°y√¨ h√°izi d≈çu yƒ´nggƒÅi xu√© Zh≈çngw√©n.', english: "It's okay, as long as you want to learn now. I think all Chinese-American children should learn Chinese.", refs: 'L11-2' },
            { speaker: 'Â≠©Â≠ê', text: 'Êàë‰πãÊâÄ‰ª•Â≠¶‰∏≠ÊñáÔºåÊòØ‰∏∫‰∫Ü‰∫ÜËß£Ëá™Â∑±ÁöÑËÉåÊôØ„ÄÇÂú®Â≠¶‰∏≠ÊñáÁöÑËøáÁ®ã‰∏≠ÔºåÊàëÂèëÁé∞ÊàëÂØπ‰∏≠ÊñáÁúüÁöÑÊúâÂÖ¥Ë∂£„ÄÇ', pinyin: 'W«í zhƒ´ su«íy«ê xu√© Zh≈çngw√©n, sh√¨ w√®ile li«éojiƒõ z√¨j«ê de b√®ij«êng. Z√†i xu√© Zh≈çngw√©n de gu√≤ch√©ng zh≈çng, w«í fƒÅxi√†n w«í du√¨ Zh≈çngw√©n zhƒìn de y«íu x√¨ngq√π.', english: "The reason I study Chinese is to understand my own background. In the process of learning Chinese, I discovered I'm really interested in Chinese.", refs: 'L11-5, L11-2, L9-3' },
            { speaker: 'Â¶àÂ¶à', text: '‰Ωú‰∏∫‰∏Ä‰∏™‰ΩèÂú®ÁæéÂõΩÁöÑ‰∏≠ÂõΩ‰∫∫ÔºåÊàë‰ª¨‰∏ÄÊñπÈù¢Ë¶ÅÁæéÂõΩÂåñÔºåÂè¶‰∏ÄÊñπÈù¢Âç¥Ë¶Å‰øùÊåÅËá™Â∑±ÂéüÊù•ÁöÑËØ≠Ë®ÄÂíåÊñáÂåñ„ÄÇ', pinyin: 'Zu√≤w√©i y√≠ ge zh√π z√†i Mƒõigu√≥ de Zh≈çnggu√≥ r√©n, w«ímen yƒ´ fƒÅngmi√†n y√†o Mƒõigu√≥hu√†, l√¨ng yƒ´ fƒÅngmi√†n qu√® y√†o b«éoch√≠ z√¨j«ê yu√°nl√°i de y«îy√°n h√© w√©nhu√†.', english: "As Chinese people living in America, on one hand we need to Americanize, but on the other hand we need to maintain our original language and culture.", refs: 'L11-3' },
            { speaker: 'Â≠©Â≠ê', text: 'Êàë‰πüÂ∏åÊúõÊõ¥Ëøõ‰∏ÄÊ≠•‰∫ÜËß£‰∏≠ÂõΩÁ§æ‰ºö„ÄÇÊàëÊÉ≥Âà©Áî®‰ªäÂπ¥Êò•ÂÅáÁöÑÊó∂Èó¥Âéª‰∏äÊµ∑ÁúãÁúãÊÇ®ÁöÑËÄÅÂÆ∂„ÄÇ', pinyin: 'W«í yƒõ xƒ´w√†ng g√®ng j√¨n yƒ´ b√π li«éojiƒõ Zh≈çnggu√≥ sh√®hu√¨. W«í xi«éng l√¨y√≤ng jƒ´nni√°n ch≈´nji√† de sh√≠jiƒÅn q√π Sh√†ngh«éi k√†nkan n√≠n de l«éojiƒÅ.', english: "I also hope to further understand Chinese society. I want to use this year's spring break to visit your hometown in Shanghai.", refs: 'L11-6, L9-7' },
            { speaker: 'Â¶àÂ¶à', text: 'ÁúãÂà∞‰Ω†Áé∞Âú®Ëøô‰πàËÆ§ÁúüÔºåÊàë‰ª¨‰∏ç‰ΩÜÂæàÈ´òÂÖ¥ÔºåËÄå‰∏îÁúüÁöÑ‰∏∫‰Ω†È™ÑÂÇ≤„ÄÇÊàë‰ª¨‰∏ÄÂÆö‰ºöÊîØÊåÅ‰Ω†„ÄÇ', pinyin: 'K√†nd√†o n«ê xi√†nz√†i zh√®me r√®nzhƒìn, w«ímen b√∫d√†n hƒõn gƒÅox√¨ng, √©rqiƒõ zhƒìn de w√®i n«ê jiƒÅo√†o. W«ímen y√≠d√¨ng hu√¨ zhƒ´ch√≠ n«ê.', english: "Seeing how serious you are now, we're not only happy, but really proud of you. We will definitely support you.", refs: 'L8-5' },
            { speaker: 'Â≠©Â≠ê', text: 'Ë∞¢Ë∞¢ÔºÅÊàë‰ª•Ââç‰ª•‰∏∫‰∏≠ÂõΩÁà∂ÊØçÈÉΩÊØîËæÉÂá∂ÔºåÂÖ∂ÂÆûÊàëÁü•ÈÅì‰Ω†‰ª¨‰πüÊòØ‰∏∫‰∫ÜÊàëÂ•Ω„ÄÇ', pinyin: 'Xi√®xie! W«í y«êqi√°n y«êw√©i Zh≈çnggu√≥ f√πm«î d≈çu b«êji√†o xi≈çng, q√≠sh√≠ w«í zhƒ´d√†o n«êmen yƒõ sh√¨ w√®ile w«í h«éo.', english: "Thank you! I used to think Chinese parents were all rather fierce, but actually I know you're doing it for my own good.", refs: 'L11-4' }
        ];

        const STORAGE_KEY = 'script-mother-child-progress';
        let currentAudio = null;
        let playbackSpeed = 1.0;
        let isHidden = false;
        let playAllIndex = -1;
        let isPlayingAll = false;
        let currentMode = 'read';
        let writeIndex = 0;
        let writeResults = [];
        let selectedRole = 'both'; // 'both', 'child', 'mother'
        let practiceMode = 'audio'; // 'audio', 'english', 'pinyin', 'speak'

        // Get indices of lines for current role
        function getRoleIndices() {
            if (selectedRole === 'both') {
                return script.map((_, i) => i);
            }
            const targetSpeaker = selectedRole === 'child' ? 'Â≠©Â≠ê' : 'Â¶àÂ¶à';
            return script.map((line, i) => line.speaker === targetSpeaker ? i : -1).filter(i => i !== -1);
        }

        // Get position in role-filtered list
        function getRolePosition(globalIndex) {
            const indices = getRoleIndices();
            return indices.indexOf(globalIndex);
        }

        // Check if current line is "my" line (needs typing) or other's line (just listen)
        function isMyLine(index) {
            if (selectedRole === 'both') return true;
            const targetSpeaker = selectedRole === 'child' ? 'Â≠©Â≠ê' : 'Â¶àÂ¶à';
            return script[index].speaker === targetSpeaker;
        }

        function setRole(role) {
            selectedRole = role;
            // Jump to first line of this role
            const indices = getRoleIndices();
            if (indices.length > 0) {
                writeIndex = indices[0];
            }
            writeResults = new Array(script.length).fill(null);
            saveProgress();
            updateWriteMode(true);
        }

        function setPracticeMode(mode) {
            practiceMode = mode;
            updateWriteMode(true);
        }

        function showSpeakAnswer() {
            const line = script[writeIndex];
            document.getElementById('speakChinese').textContent = line.text;
            document.getElementById('speakPinyin').textContent = line.pinyin;
            document.getElementById('speakAnswer').classList.add('show');
        }

        // Chinese and common punctuation to ignore
        const PUNCTUATION = /[Ôºå„ÄÇÔºüÔºÅ„ÄÅÔºöÔºõ""''ÔºàÔºâ,.\?!:;"'()\s]/g;

        function stripPunctuation(str) {
            return str.replace(PUNCTUATION, '');
        }

        function onInputChange() {
            const input = document.getElementById('writeInput').value;
            const expected = script[writeIndex].text;
            const liveFeedback = document.getElementById('liveFeedback');
            const charCount = document.getElementById('charCount');

            // Strip punctuation for comparison
            const inputClean = stripPunctuation(input);
            const expectedClean = stripPunctuation(expected);

            // Build display with smart matching
            let html = '';
            let inputIdx = 0;
            let expectedIdx = 0;
            let correctCount = 0;

            // Process expected characters, matching against input
            while (expectedIdx < expected.length) {
                const expChar = expected[expectedIdx];

                if (PUNCTUATION.test(expChar)) {
                    // Punctuation - show as optional/skippable
                    html += `<span class="char-punct">${expChar}</span>`;
                    expectedIdx++;
                    continue;
                }

                if (inputIdx < input.length) {
                    const inChar = input[inputIdx];

                    if (PUNCTUATION.test(inChar)) {
                        // User typed punctuation - just skip it in input, show dimmed
                        html += `<span class="char-punct-typed">${inChar}</span>`;
                        inputIdx++;
                        continue;
                    }

                    if (inChar === expChar) {
                        // Correct character
                        html += `<span class="char-correct">${inChar}</span>`;
                        correctCount++;
                        inputIdx++;
                        expectedIdx++;
                    } else {
                        // Check if this char appears soon in expected (user might have skipped)
                        const lookAhead = expectedClean.indexOf(inChar, expectedIdx - countNonPunct(expected.slice(0, expectedIdx)));
                        if (lookAhead !== -1 && lookAhead < expectedIdx + 3) {
                            // User skipped ahead - mark current expected as missed, but continue
                            html += `<span class="char-skipped">${expChar}</span>`;
                            expectedIdx++;
                        } else {
                            // Wrong character
                            html += `<span class="char-wrong">${inChar}</span>`;
                            inputIdx++;
                            expectedIdx++;
                        }
                    }
                } else {
                    // No more input - show remaining as expected
                    html += `<span class="char-expected">${expChar}</span>`;
                    expectedIdx++;
                }
            }

            // Any extra input characters
            while (inputIdx < input.length) {
                const inChar = input[inputIdx];
                if (PUNCTUATION.test(inChar)) {
                    html += `<span class="char-punct-typed">${inChar}</span>`;
                } else {
                    html += `<span class="char-wrong">${inChar}</span>`;
                }
                inputIdx++;
            }

            // Add cursor at current position
            const cursorPos = html.lastIndexOf('</span>') + 7;
            html = html.slice(0, cursorPos) + '<span class="char-cursor"></span>' + html.slice(cursorPos);

            liveFeedback.innerHTML = html;
            charCount.textContent = `${inputClean.length} / ${expectedClean.length}`;

            // Check if complete - compare stripped versions
            const isComplete = inputClean.length >= expectedClean.length;
            const isCorrect = inputClean === expectedClean;

            if (isComplete && isCorrect) {
                liveFeedback.classList.add('complete');
                writeResults[writeIndex] = true;
                updateProgressBar();
                updateScore();
                saveProgress();

                const indices = getRoleIndices();
                const currentPos = getRolePosition(writeIndex);
                if (document.getElementById('autoAdvanceCheck').checked && currentPos < indices.length - 1) {
                    setTimeout(() => {
                        writeIndex = indices[currentPos + 1];
                        updateWriteMode();
                    }, 500);
                }
            } else {
                liveFeedback.classList.remove('complete');
            }
        }

        function countNonPunct(str) {
            return stripPunctuation(str).length;
        }

        function initLiveFeedback() {
            const expected = script[writeIndex].text;
            const expectedClean = stripPunctuation(expected);
            const liveFeedback = document.getElementById('liveFeedback');
            const charCount = document.getElementById('charCount');

            let html = '<span class="char-cursor"></span>';
            for (let i = 0; i < expected.length; i++) {
                const char = expected[i];
                if (PUNCTUATION.test(char)) {
                    html += `<span class="char-punct">${char}</span>`;
                } else {
                    html += `<span class="char-expected">${char}</span>`;
                }
            }

            liveFeedback.innerHTML = html;
            liveFeedback.classList.remove('complete');
            charCount.textContent = `0 / ${expectedClean.length}`;
        }

        // Load saved progress
        function loadProgress() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    const data = JSON.parse(saved);
                    writeIndex = data.writeIndex || 0;
                    writeResults = data.writeResults || new Array(script.length).fill(null);
                }
            } catch (e) {}
        }

        // Save progress
        function saveProgress() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify({
                    writeIndex,
                    writeResults
                }));
            } catch (e) {}
        }

        function renderScript() {
            const container = document.getElementById('scriptLines');
            container.innerHTML = script.map((line, i) => `
                <div class="line" data-index="${i}">
                    <button class="play-btn" onclick="playLine(${i})">üîä</button>
                    <span class="speaker ${line.speaker === 'Â≠©Â≠ê' ? 'child' : ''}">${line.speaker}:</span>
                    <div class="line-content">
                        <div class="chinese">${line.text}</div>
                        <div class="line-pinyin">${line.pinyin}</div>
                        <div class="line-english">${line.english}</div>
                    </div>
                    ${line.refs ? `<span class="grammar-refs">${line.refs}</span>` : ''}
                </div>
            `).join('');
        }

        function playLine(index) {
            stopAudio();
            const line = script[index];
            const text = line.text;
            const url = `https://translate.google.com/translate_tts?ie=UTF-8&client=tw-ob&tl=zh-CN&q=${encodeURIComponent(text)}`;

            currentAudio = new Audio(url);
            currentAudio.playbackRate = playbackSpeed;

            const btn = document.querySelector(`.line[data-index="${index}"] .play-btn`);
            if (btn) btn.classList.add('playing');

            currentAudio.onended = () => {
                if (btn) btn.classList.remove('playing');
                if (isPlayingAll && playAllIndex < script.length - 1) {
                    playAllIndex++;
                    setTimeout(() => playLine(playAllIndex), 500);
                } else {
                    isPlayingAll = false;
                    playAllIndex = -1;
                }
            };

            currentAudio.onerror = () => {
                if (btn) btn.classList.remove('playing');
                isPlayingAll = false;
            };

            currentAudio.play();
        }

        function playAll() {
            stopAudio();
            isPlayingAll = true;
            playAllIndex = 0;
            playLine(0);
        }

        function stopAudio() {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }
            isPlayingAll = false;
            playAllIndex = -1;
            document.querySelectorAll('.play-btn').forEach(btn => btn.classList.remove('playing'));
        }

        function setSpeed(speed) {
            playbackSpeed = speed;
            if (currentAudio) {
                currentAudio.playbackRate = speed;
            }
            document.querySelectorAll('.control-btn').forEach(btn => {
                if (btn.textContent.includes('x')) {
                    btn.classList.toggle('active', btn.textContent === speed + 'x');
                }
            });
        }

        function toggleHide() {
            isHidden = !isHidden;
            document.getElementById('scriptLines').classList.toggle('hidden-text', isHidden);
            document.getElementById('hideBtn').textContent = isHidden ? 'Show Text' : 'Hide Text';
            document.getElementById('hideBtn').classList.toggle('active', isHidden);
        }

        function setMode(mode) {
            currentMode = mode;
            document.getElementById('readMode').style.display = mode === 'read' ? 'block' : 'none';
            document.getElementById('writeMode').classList.toggle('active', mode === 'write');
            document.getElementById('readModeBtn').classList.toggle('active', mode === 'read');
            document.getElementById('writeModeBtn').classList.toggle('active', mode === 'write');

            if (mode === 'write') {
                loadProgress();
                if (!writeResults || writeResults.length !== script.length) {
                    writeResults = new Array(script.length).fill(null);
                }
                updateWriteMode();
            }
        }

        function updateWriteMode(skipAutoPlay = false) {
            const line = script[writeIndex];
            document.getElementById('writeSpeaker').textContent = line.speaker + ': (your line)';
            document.getElementById('writeSpeaker').className = 'speaker-label' + (line.speaker === 'Â≠©Â≠ê' ? ' child' : '');
            document.getElementById('writeInput').value = '';
            document.getElementById('writeInput').className = 'write-input-area';
            document.getElementById('writeFeedback').className = 'write-feedback';

            // Show context line (previous line) when in role mode
            const contextEl = document.getElementById('contextLine');
            if (selectedRole !== 'both' && writeIndex > 0) {
                const prevLine = script[writeIndex - 1];
                document.getElementById('contextSpeaker').textContent = prevLine.speaker + ':';
                document.getElementById('contextSpeaker').className = 'context-speaker ' + (prevLine.speaker === 'Â¶àÂ¶à' ? 'mother' : 'child');
                document.getElementById('contextText').textContent = prevLine.text;
                document.getElementById('contextEnglish').textContent = prevLine.english;
                contextEl.style.display = 'block';
            } else {
                contextEl.style.display = 'none';
            }

            // Handle different practice modes
            const promptHint = document.getElementById('promptHint');
            const hintText = document.getElementById('hintText');
            const typeSection = document.getElementById('typeSection');
            const speakSection = document.getElementById('speakSection');
            const writeControls = document.querySelector('.write-controls');

            if (practiceMode === 'speak') {
                // Listen & Speak mode - no typing
                typeSection.style.display = 'none';
                speakSection.style.display = 'block';
                writeControls.style.display = 'none';
                promptHint.style.display = 'none';
                hintText.textContent = 'Listen and repeat out loud';
                document.getElementById('speakAnswer').classList.remove('show');
            } else {
                // Typing modes
                typeSection.style.display = 'block';
                speakSection.style.display = 'none';
                writeControls.style.display = 'flex';
                document.getElementById('writeInput').focus();
                initLiveFeedback();

                if (practiceMode === 'english') {
                    promptHint.textContent = line.english;
                    promptHint.className = 'prompt-hint english';
                    promptHint.style.display = 'block';
                    hintText.textContent = 'Type the Chinese for this sentence';
                } else if (practiceMode === 'pinyin') {
                    promptHint.textContent = line.pinyin;
                    promptHint.className = 'prompt-hint pinyin';
                    promptHint.style.display = 'block';
                    hintText.textContent = 'Type the Chinese characters';
                } else {
                    // audio mode
                    promptHint.style.display = 'none';
                    hintText.textContent = 'Listen and type the Chinese characters';
                }
            }

            updateProgressBar();
            updateScore();
            saveProgress();

            // Auto-play audio if enabled
            if (!skipAutoPlay && document.getElementById('autoPlayCheck').checked) {
                setTimeout(() => playCurrentLine(), 100);
            }
        }

        function playContextLine() {
            if (writeIndex > 0) {
                const prevLine = script[writeIndex - 1];
                const url = `https://translate.google.com/translate_tts?ie=UTF-8&client=tw-ob&tl=zh-CN&q=${encodeURIComponent(prevLine.text)}`;
                if (currentAudio) currentAudio.pause();
                currentAudio = new Audio(url);
                currentAudio.playbackRate = playbackSpeed;
                currentAudio.play();
            }
        }

        function updateProgressBar() {
            const bar = document.getElementById('progressBar');
            const indices = getRoleIndices();
            bar.innerHTML = indices.map((scriptIdx) => {
                let cls = 'progress-dot';
                if (scriptIdx === writeIndex) cls += ' current';
                else if (writeResults[scriptIdx] === true) cls += ' correct';
                else if (writeResults[scriptIdx] === false) cls += ' incorrect';
                return `<div class="${cls}" onclick="jumpToLine(${scriptIdx})" title="Line ${scriptIdx + 1}"></div>`;
            }).join('');
        }

        function updateScore() {
            const indices = getRoleIndices();
            const correct = indices.filter(i => writeResults[i] === true).length;
            const attempted = indices.filter(i => writeResults[i] !== null).length;
            const position = getRolePosition(writeIndex) + 1;
            document.getElementById('scoreDisplay').textContent = `Score: ${correct}/${attempted}`;
            document.getElementById('lineCounter').textContent = `Line ${position} of ${indices.length}`;
        }

        function jumpToLine(index) {
            writeIndex = index;
            updateWriteMode();
        }

        function restartWrite() {
            const indices = getRoleIndices();
            writeIndex = indices.length > 0 ? indices[0] : 0;
            writeResults = new Array(script.length).fill(null);
            saveProgress();
            updateWriteMode();
        }

        function playCurrentLine() {
            const line = script[writeIndex];
            const url = `https://translate.google.com/translate_tts?ie=UTF-8&client=tw-ob&tl=zh-CN&q=${encodeURIComponent(line.text)}`;
            if (currentAudio) currentAudio.pause();
            currentAudio = new Audio(url);
            currentAudio.playbackRate = playbackSpeed;
            currentAudio.play();
        }

        function checkWriteAnswer() {
            const input = document.getElementById('writeInput').value.trim();
            const expected = script[writeIndex].text;
            const isCorrect = input === expected;

            writeResults[writeIndex] = isCorrect;

            const inputEl = document.getElementById('writeInput');
            const feedbackEl = document.getElementById('writeFeedback');
            const diffEl = document.getElementById('diffDisplay');

            inputEl.classList.remove('correct', 'incorrect');
            inputEl.classList.add(isCorrect ? 'correct' : 'incorrect');

            feedbackEl.classList.remove('correct', 'incorrect');
            feedbackEl.classList.add('show', isCorrect ? 'correct' : 'incorrect');

            if (isCorrect) {
                diffEl.innerHTML = '<span class="diff-correct">‚úì Correct!</span>';
                // Auto-advance if enabled
                const indices = getRoleIndices();
                const currentPos = getRolePosition(writeIndex);
                if (document.getElementById('autoAdvanceCheck').checked && currentPos < indices.length - 1) {
                    setTimeout(() => {
                        writeIndex = indices[currentPos + 1];
                        updateWriteMode();
                    }, 800);
                }
            } else {
                const line = script[writeIndex];
                diffEl.innerHTML = `
                    ${generateDiff(input, expected)}
                    <div class="answer-details">
                        <div class="label">Correct Answer</div>
                        <div class="correct-answer">${expected}</div>
                        <div class="label">Pinyin</div>
                        <div class="pinyin">${line.pinyin}</div>
                        <div class="label">English</div>
                        <div class="english">${line.english}</div>
                        ${line.refs ? `<div class="grammar-ref">Grammar: ${line.refs}</div>` : ''}
                    </div>
                `;
            }

            updateProgressBar();
            updateScore();
            saveProgress();
        }

        function generateDiff(input, expected) {
            let result = '';
            const maxLen = Math.max(input.length, expected.length);

            for (let i = 0; i < maxLen; i++) {
                if (i < input.length && i < expected.length) {
                    if (input[i] === expected[i]) {
                        result += `<span class="diff-correct">${expected[i]}</span>`;
                    } else {
                        result += `<span class="diff-wrong">${input[i]}</span><span class="diff-missing">${expected[i]}</span>`;
                    }
                } else if (i < input.length) {
                    result += `<span class="diff-wrong">${input[i]}</span>`;
                } else {
                    result += `<span class="diff-missing">${expected[i]}</span>`;
                }
            }

            return result;
        }

        function showWriteAnswer() {
            const expected = script[writeIndex].text;
            document.getElementById('writeInput').value = expected;
            document.getElementById('writeInput').classList.add('correct');

            const feedbackEl = document.getElementById('writeFeedback');
            feedbackEl.classList.add('show', 'correct');
            document.getElementById('diffDisplay').innerHTML = `<span style="color: #6b7280;">Answer shown</span>`;
        }

        function nextWriteLine() {
            const indices = getRoleIndices();
            const currentPos = getRolePosition(writeIndex);
            if (currentPos < indices.length - 1) {
                writeIndex = indices[currentPos + 1];
                updateWriteMode();
            }
        }

        function prevWriteLine() {
            const indices = getRoleIndices();
            const currentPos = getRolePosition(writeIndex);
            if (currentPos > 0) {
                writeIndex = indices[currentPos - 1];
                updateWriteMode();
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (currentMode === 'write') {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    checkWriteAnswer();
                } else if (e.key === 'ArrowRight' && e.ctrlKey) {
                    nextWriteLine();
                } else if (e.key === 'ArrowLeft' && e.ctrlKey) {
                    prevWriteLine();
                } else if (e.key === ';') {
                    e.preventDefault();
                    playCurrentLine();
                }
            }
        });

        renderScript();
        setMode('read');
    </script>
</body>
</html>
