<!DOCTYPE html>
<html lang="zh-CN" translate="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google" content="notranslate">
    <title>Character Sheet 1 Quiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5/dist/hanzi-writer.min.js"></script>
    <link rel="stylesheet" href="css/common.css">
    <script src="js/utils.js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8">
    <a href="home.html" class="fixed top-4 left-4 bg-white hover:bg-gray-100 text-gray-700 px-3 py-2 rounded-lg shadow border border-gray-200 transition text-sm">‚Üê Home</a>

    <div class="max-w-3xl mx-auto bg-white rounded-xl shadow-lg p-6 md:p-8 mt-16 md:mt-0">
        <h1 class="text-3xl font-bold text-center mb-6 text-gray-800">Ê±âÂ≠óÁªÉ‰π†-1 Quiz</h1>

        <!-- Mode Selector -->
        <div class="flex flex-wrap gap-2 justify-center mb-6">
            <button class="mode-btn px-4 py-2 rounded-lg border-2 border-gray-300 hover:bg-gray-100 transition active:bg-blue-500 active:text-white active:border-blue-500" data-mode="char-to-pinyin">Char ‚Üí Pinyin</button>
            <button class="mode-btn px-4 py-2 rounded-lg border-2 border-gray-300 hover:bg-gray-100 transition" data-mode="char-to-pinyin-mc">Char ‚Üí Pinyin (MC)</button>
            <button class="mode-btn px-4 py-2 rounded-lg border-2 border-gray-300 hover:bg-gray-100 transition" data-mode="audio-to-pinyin">Audio ‚Üí Pinyin</button>
            <button class="mode-btn px-4 py-2 rounded-lg border-2 border-gray-300 hover:bg-gray-100 transition" data-mode="pinyin-to-char">Pinyin ‚Üí Char</button>
            <button class="mode-btn px-4 py-2 rounded-lg border-2 border-gray-300 hover:bg-gray-100 transition" data-mode="char-to-meaning">Char ‚Üí Meaning</button>
            <button class="mode-btn px-4 py-2 rounded-lg border-2 border-gray-300 hover:bg-gray-100 transition" data-mode="char-to-meaning-type">Char ‚Üí Meaning (Fuzzy)</button>
            <button class="mode-btn px-4 py-2 rounded-lg border-2 border-gray-300 hover:bg-gray-100 transition" data-mode="meaning-to-char">Meaning ‚Üí Char</button>
            <button class="mode-btn px-4 py-2 rounded-lg border-2 border-gray-300 hover:bg-gray-100 transition" data-mode="stroke-order">Stroke Order</button>
            <button class="mode-btn px-4 py-2 rounded-lg border-2 border-gray-300 hover:bg-gray-100 transition" data-mode="handwriting">Handwriting</button>
            <button class="mode-btn px-4 py-2 rounded-lg border-2 border-gray-300 hover:bg-gray-100 transition" data-mode="draw-char">Draw Character</button>
        </div>

        <!-- Question Display -->
        <div id="questionDisplay" class="text-center"></div>

        <!-- Hint -->
        <div id="hint" class="text-center text-sm my-4 min-h-[20px]"></div>

        <!-- Audio Section -->
        <div id="audioSection" class="text-center my-4 hidden">
            <button id="playAudioBtn" class="bg-cyan-500 hover:bg-cyan-600 text-white px-6 py-3 rounded-lg transition">üîä Play Sound</button>
        </div>

        <!-- Type Mode -->
        <div id="typeMode" class="space-y-4">
            <input type="text" id="answerInput" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none text-lg" placeholder="Type your answer...">
            <button id="checkBtn" class="w-full bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg font-semibold transition">Check Answer</button>
        </div>

        <!-- Choice Mode -->
        <div id="choiceMode" class="hidden">
            <div id="options" class="grid grid-cols-2 gap-3"></div>
        </div>

        <!-- Fuzzy Mode -->
        <div id="fuzzyMode" class="hidden space-y-4">
            <input type="text" id="fuzzyInput" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none text-lg" placeholder="Type your answer...">
            <div id="fuzzyOptions" class="grid grid-cols-2 gap-3"></div>
        </div>

        <!-- Stroke Order Mode -->
        <div id="strokeOrderMode" class="hidden">
            <div id="strokeOrderWriter" class="mx-auto my-8"></div>
            <div class="flex gap-3 justify-center">
                <button id="animateBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg transition">‚ñ∂Ô∏è Animate</button>
                <button id="quizBtn" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg transition">‚úçÔ∏è Quiz</button>
                <button id="showOutlineBtn" class="bg-purple-500 hover:bg-purple-600 text-white px-6 py-2 rounded-lg transition">üëÅÔ∏è Show</button>
                <button id="hideOutlineBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition">üö´ Hide</button>
            </div>
        </div>

        <!-- Handwriting Mode -->
        <div id="handwritingMode" class="hidden">
            <div class="text-center text-gray-600 mb-4">Practice writing on paper, then reveal the answer</div>
            <div id="handwritingWriter" class="mx-auto my-8"></div>
            <div class="flex justify-center">
                <button id="hwShowBtn" class="bg-green-500 hover:bg-green-600 text-white px-8 py-3 rounded-lg transition text-lg">Show Answer & Next</button>
            </div>
        </div>

        <!-- Draw Character Mode -->
        <div id="drawCharMode" class="hidden">
            <canvas id="drawCanvas" class="border-2 border-gray-300 rounded-lg mx-auto cursor-crosshair" width="300" height="300"></canvas>
            <div class="flex gap-3 justify-center mt-4">
                <button id="clearCanvasBtn" class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg transition">üóëÔ∏è Clear</button>
                <button id="submitDrawBtn" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg transition">‚úì Submit</button>
            </div>
        </div>

        <!-- Feedback -->
        <div id="feedback" class="text-center font-semibold my-4 min-h-[24px]"></div>

        <!-- Stats -->
        <div class="flex justify-between text-sm text-gray-600 pt-4 border-t border-gray-200">
            <span>Score: <span id="score" class="font-semibold">0</span>/<span id="total" class="font-semibold">0</span></span>
            <span>Accuracy: <span id="accuracy" class="font-semibold">0%</span></span>
        </div>
    </div>

    <script>
        const characters = [
            { char: 'Êó•', pinyin: 'r√¨', meaning: 'sun' },
            { char: 'Êúà', pinyin: 'yu√®', meaning: 'moon' },
            { char: 'Ê∞¥', pinyin: 'shu«ê', meaning: 'water' },
            { char: 'ÁÅ´', pinyin: 'hu«í', meaning: 'fire' },
            { char: 'Â±±', pinyin: 'shƒÅn', meaning: 'mountain' },
            { char: '‰∫∫', pinyin: 'r√©n', meaning: 'person' },
            { char: 'ÂàÄ', pinyin: 'dƒÅo', meaning: 'knife' },
            { char: 'Áî∞', pinyin: 'ti√°n', meaning: 'field' },
            { char: 'Êú®', pinyin: 'm√π', meaning: 'tree' },
            { char: 'Á´π', pinyin: 'zh√∫', meaning: 'bamboo' }
        ];

        let currentQuestion = null;
        let mode = 'char-to-pinyin';
        let answered = false;
        let score = 0;
        let total = 0;

        // DOM elements
        const questionDisplay = document.getElementById('questionDisplay');
        const answerInput = document.getElementById('answerInput');
        const checkBtn = document.getElementById('checkBtn');
        const feedback = document.getElementById('feedback');
        const hint = document.getElementById('hint');
        const typeMode = document.getElementById('typeMode');
        const choiceMode = document.getElementById('choiceMode');
        const fuzzyMode = document.getElementById('fuzzyMode');
        const fuzzyInput = document.getElementById('fuzzyInput');
        const audioSection = document.getElementById('audioSection');
        const strokeOrderMode = document.getElementById('strokeOrderMode');
        const handwritingMode = document.getElementById('handwritingMode');
        const drawCharMode = document.getElementById('drawCharMode');

        // Hanzi Writer variable
        let writer = null;

        // Sound effect functions
        // Sound functions now loaded from utils.js

        // Canvas drawing variables
        let canvas, ctx;
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;

        function initCanvas() {
            canvas = document.getElementById('drawCanvas');
            ctx = canvas.getContext('2d');
            ctx.lineWidth = 8;
            ctx.lineCap = 'round';
            ctx.strokeStyle = '#000';

            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);

            // Touch support
            canvas.addEventListener('touchstart', handleTouchStart);
            canvas.addEventListener('touchmove', handleTouchMove);
            canvas.addEventListener('touchend', stopDrawing);
        }

        function startDrawing(e) {
            isDrawing = true;
            [lastX, lastY] = [e.offsetX, e.offsetY];
        }

        function draw(e) {
            if (!isDrawing) return;
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(e.offsetX, e.offsetY);
            ctx.stroke();
            [lastX, lastY] = [e.offsetX, e.offsetY];
        }

        function stopDrawing() {
            isDrawing = false;
        }

        function handleTouchStart(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            isDrawing = true;
            lastX = touch.clientX - rect.left;
            lastY = touch.clientY - rect.top;
        }

        function handleTouchMove(e) {
            if (!isDrawing) return;
            e.preventDefault();
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;

            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(x, y);
            ctx.stroke();
            [lastX, lastY] = [x, y];
        }

        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        document.getElementById('clearCanvasBtn').addEventListener('click', clearCanvas);
        document.getElementById('submitDrawBtn').addEventListener('click', () => {
            feedback.textContent = `Expected: ${currentQuestion.char} (${currentQuestion.pinyin}) - ${currentQuestion.meaning}`;
            feedback.className = 'text-blue-600';
            setTimeout(() => {
                clearCanvas();
                generateQuestion();
            }, 2000);
        });

        // Mode switching
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.mode-btn').forEach(b => {
                    b.classList.remove('active', 'bg-blue-500', 'text-white', 'border-blue-500');
                });
                btn.classList.add('active', 'bg-blue-500', 'text-white', 'border-blue-500');
                mode = btn.dataset.mode;
                generateQuestion();
            });
        });

        // pinyinToAudioKey now loaded from utils.js

        function generateQuestion() {
            answered = false;
            feedback.textContent = '';
            hint.textContent = '';
            answerInput.value = '';
            fuzzyInput.value = '';

            currentQuestion = characters[Math.floor(Math.random() * characters.length)];

            // Hide all modes
            typeMode.classList.add('hidden');
            choiceMode.classList.add('hidden');
            fuzzyMode.classList.add('hidden');
            audioSection.classList.add('hidden');
            strokeOrderMode.classList.add('hidden');
            handwritingMode.classList.add('hidden');
            drawCharMode.classList.add('hidden');

            if (mode === 'char-to-pinyin') {
                questionDisplay.innerHTML = `<div class="text-8xl my-10 text-center">${currentQuestion.char}</div>`;
                answerInput.placeholder = 'e.g., m«é or ma3';
                typeMode.classList.remove('hidden');
                audioSection.classList.remove('hidden');
                document.getElementById('playAudioBtn').onclick = () => {
                    const firstPinyin = currentQuestion.pinyin.split('/').map(p => p.trim())[0];
                    const audioKey = pinyinToAudioKey(firstPinyin);
                    if (audioKey) {
                        const audioUrl = `https://www.purpleculture.net/mp3/${audioKey}.mp3`;
                        const audio = new Audio(audioUrl);
                        audio.play().catch(e => console.log('Audio play failed:', e));
                    }
                };
                answerInput.focus();
            } else if (mode === 'audio-to-pinyin') {
                questionDisplay.innerHTML = `<div class="text-center my-10"><button class="bg-cyan-500 hover:bg-cyan-600 text-white text-2xl px-10 py-5 rounded-lg" id="playAudioDictation">üîä Play Audio</button></div><div class="text-center text-gray-500 text-sm mt-5">Type with tone marks (m«é) or numbers (ma3)</div>`;
                answerInput.placeholder = 'e.g., m«é or ma3';
                typeMode.classList.remove('hidden');

                setTimeout(() => {
                    const playBtn = document.getElementById('playAudioDictation');

                    window.currentAudioPlayFunc = () => {
                        const firstPinyin = currentQuestion.pinyin.split('/').map(p => p.trim())[0];
                        const audioKey = pinyinToAudioKey(firstPinyin);
                        if (audioKey) {
                            const audioUrl = `https://www.purpleculture.net/mp3/${audioKey}.mp3`;
                            const audio = new Audio(audioUrl);
                            audio.play().catch(e => console.log('Audio play failed:', e));
                        }
                    };

                    if (playBtn) {
                        playBtn.onclick = window.currentAudioPlayFunc;
                    }

                    window.currentAudioPlayFunc();
                    answerInput.focus();
                }, 100);
            } else if (mode === 'pinyin-to-char') {
                questionDisplay.innerHTML = `<div class="text-5xl my-10 text-center">${currentQuestion.pinyin}</div>`;
                generateCharOptions();
            } else if (mode === 'char-to-pinyin-mc') {
                questionDisplay.innerHTML = `<div class="text-8xl my-10 text-center">${currentQuestion.char}</div>`;
                generatePinyinOptions();
            } else if (mode === 'char-to-meaning') {
                questionDisplay.innerHTML = `<div class="text-8xl my-10 text-center">${currentQuestion.char}</div>`;
                generateMeaningOptions();
            } else if (mode === 'char-to-meaning-type') {
                questionDisplay.innerHTML = `<div class="text-8xl my-10 text-center">${currentQuestion.char}</div>`;
                generateFuzzyMeaningOptions();
            } else if (mode === 'meaning-to-char') {
                questionDisplay.innerHTML = `<div class="text-3xl my-10 text-center">${currentQuestion.meaning}</div>`;
                generateCharOptions();
            } else if (mode === 'stroke-order') {
                questionDisplay.innerHTML = `<div class="text-2xl my-4 text-center text-gray-600">${currentQuestion.pinyin} - ${currentQuestion.meaning}</div>`;
                strokeOrderMode.classList.remove('hidden');
                initStrokeOrder();
            } else if (mode === 'handwriting') {
                questionDisplay.innerHTML = `<div class="text-2xl my-4 text-center text-gray-600">${currentQuestion.pinyin} - ${currentQuestion.meaning}</div>`;
                handwritingMode.classList.remove('hidden');
                initHandwriting();
            } else if (mode === 'draw-char') {
                questionDisplay.innerHTML = `<div class="text-3xl my-10 text-center">${currentQuestion.pinyin} - ${currentQuestion.meaning}</div>`;
                drawCharMode.classList.remove('hidden');
                if (!canvas) initCanvas();
                clearCanvas();
            }

            updateStats();
        }

        function initStrokeOrder() {
            const writerDiv = document.getElementById('strokeOrderWriter');
            writerDiv.innerHTML = '';

            writer = HanziWriter.create(writerDiv, currentQuestion.char, {
                width: 300,
                height: 300,
                padding: 5,
                showOutline: true,
                strokeAnimationSpeed: 1,
                delayBetweenStrokes: 200
            });

            document.getElementById('animateBtn').onclick = () => writer.animateCharacter();
            document.getElementById('quizBtn').onclick = () => {
                writer.quiz({
                    onComplete: () => {
                        feedback.textContent = '‚úì Great job!';
                        feedback.className = 'text-green-600';
                        setTimeout(generateQuestion, 1500);
                    }
                });
            };
            document.getElementById('showOutlineBtn').onclick = () => writer.showOutline();
            document.getElementById('hideOutlineBtn').onclick = () => writer.hideOutline();
        }

        function initHandwriting() {
            const writerDiv = document.getElementById('handwritingWriter');
            writerDiv.innerHTML = '';

            writer = HanziWriter.create(writerDiv, currentQuestion.char, {
                width: 300,
                height: 300,
                padding: 5,
                showOutline: false,
                showCharacter: false
            });

            document.getElementById('hwShowBtn').onclick = () => {
                writer.showCharacter();
                writer.showOutline();

                feedback.textContent = `${currentQuestion.char} (${currentQuestion.pinyin}) - ${currentQuestion.meaning}`;
                feedback.className = 'text-blue-600';

                setTimeout(() => {
                    generateQuestion();
                }, 2000);
            };
        }

        function generatePinyinOptions() {
            const options = document.getElementById('options');
            options.innerHTML = '';

            const wrongOptions = [];
            while (wrongOptions.length < 3) {
                const random = characters[Math.floor(Math.random() * characters.length)];
                if (random.pinyin !== currentQuestion.pinyin && !wrongOptions.includes(random.pinyin)) {
                    wrongOptions.push(random.pinyin);
                }
            }

            const allOptions = [...wrongOptions, currentQuestion.pinyin];
            allOptions.sort(() => Math.random() - 0.5);

            allOptions.forEach(option => {
                const btn = document.createElement('button');
                btn.className = 'px-4 py-3 bg-gray-100 hover:bg-gray-200 rounded-lg border-2 border-gray-300 transition';
                btn.textContent = option;
                btn.onclick = () => checkMultipleChoice(option);
                options.appendChild(btn);
            });

            choiceMode.classList.remove('hidden');
        }

        function generateCharOptions() {
            const options = document.getElementById('options');
            options.innerHTML = '';

            const wrongOptions = [];
            while (wrongOptions.length < 3) {
                const random = characters[Math.floor(Math.random() * characters.length)];
                if (random.char !== currentQuestion.char && !wrongOptions.includes(random.char)) {
                    wrongOptions.push(random.char);
                }
            }

            const allOptions = [...wrongOptions, currentQuestion.char];
            allOptions.sort(() => Math.random() - 0.5);

            allOptions.forEach(option => {
                const btn = document.createElement('button');
                btn.className = 'px-4 py-3 text-4xl bg-gray-100 hover:bg-gray-200 rounded-lg border-2 border-gray-300 transition';
                btn.textContent = option;
                btn.onclick = () => checkMultipleChoice(option);
                options.appendChild(btn);
            });

            choiceMode.classList.remove('hidden');
        }

        function generateMeaningOptions() {
            const options = document.getElementById('options');
            options.innerHTML = '';

            const wrongOptions = [];
            while (wrongOptions.length < 3) {
                const random = characters[Math.floor(Math.random() * characters.length)];
                if (random.meaning !== currentQuestion.meaning && !wrongOptions.includes(random.meaning)) {
                    wrongOptions.push(random.meaning);
                }
            }

            const allOptions = [...wrongOptions, currentQuestion.meaning];
            allOptions.sort(() => Math.random() - 0.5);

            allOptions.forEach(option => {
                const btn = document.createElement('button');
                btn.className = 'px-4 py-3 bg-gray-100 hover:bg-gray-200 rounded-lg border-2 border-gray-300 transition';
                btn.textContent = option;
                btn.onclick = () => checkMultipleChoice(option);
                options.appendChild(btn);
            });

            choiceMode.classList.remove('hidden');
        }

        // fuzzyMatch now loaded from utils.js

        function generateFuzzyMeaningOptions() {
            const options = document.getElementById('fuzzyOptions');
            options.innerHTML = '';
            fuzzyInput.value = '';

            const wrongOptions = [];
            while (wrongOptions.length < 3) {
                const random = characters[Math.floor(Math.random() * characters.length)];
                if (random.char !== currentQuestion.char && !wrongOptions.includes(random.meaning)) {
                    wrongOptions.push(random.meaning);
                }
            }

            const allOptions = [...wrongOptions, currentQuestion.meaning];
            allOptions.sort(() => Math.random() - 0.5);

            allOptions.forEach((option, index) => {
                const btn = document.createElement('button');
                btn.className = 'px-4 py-3 bg-gray-100 hover:bg-gray-200 rounded-lg border-2 border-gray-300 transition';
                btn.textContent = option;
                btn.dataset.index = index;
                btn.dataset.meaning = option;
                btn.onclick = () => checkFuzzyAnswer(option);
                options.appendChild(btn);
            });

            fuzzyInput.oninput = () => {
                const input = fuzzyInput.value.trim().toLowerCase();
                if (!input) {
                    document.querySelectorAll('#fuzzyOptions button').forEach(btn => {
                        btn.classList.remove('selected');
                    });
                    return;
                }

                let bestMatch = null;
                let bestScore = -1;

                allOptions.forEach((option, index) => {
                    const score = fuzzyMatch(input, option.toLowerCase());
                    if (score > bestScore) {
                        bestScore = score;
                        bestMatch = index;
                    }
                });

                document.querySelectorAll('#fuzzyOptions button').forEach((btn, idx) => {
                    if (idx === bestMatch) {
                        btn.classList.add('selected');
                    } else {
                        btn.classList.remove('selected');
                    }
                });
            };

            fuzzyInput.onkeydown = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const selected = document.querySelector('#fuzzyOptions button.selected');
                    if (selected) {
                        selected.click();
                    }
                }
            };

            fuzzyMode.classList.remove('hidden');
            fuzzyInput.focus();
        }

        function checkFuzzyAnswer(answer) {
            if (answered) return;
            answered = true;
            total++;
            const correct = answer === currentQuestion.meaning;

            const firstPinyin = currentQuestion.pinyin.split('/').map(p => p.trim())[0];
            const audioKey = pinyinToAudioKey(firstPinyin);
            if (audioKey) {
                const audioUrl = `https://www.purpleculture.net/mp3/${audioKey}.mp3`;
                const audio = new Audio(audioUrl);
                audio.play().catch(e => console.log('Audio play failed:', e));
            }

            if (correct) {
                playCorrectSound();
                score++;
                feedback.textContent = `‚úì Correct!`;
                feedback.className = 'text-green-600';
                hint.textContent = `${currentQuestion.char} (${currentQuestion.pinyin})`;
                hint.className = 'text-green-600';

                const btn = document.querySelector(`#fuzzyOptions button[data-meaning="${answer}"]`);
                if (btn) btn.classList.add('bg-green-500', 'text-white');

                document.querySelectorAll('#fuzzyOptions button').forEach(btn => {
                    btn.disabled = true;
                    btn.classList.add('cursor-not-allowed');
                });

                updateStats();
                setTimeout(() => {
                    generateQuestion();
                }, 800);
            } else {
                playWrongSound();
                feedback.textContent = `‚úó Wrong. The answer is: ${currentQuestion.meaning}`;
                feedback.className = 'text-red-600';
                hint.textContent = `${currentQuestion.char} (${currentQuestion.pinyin})`;
                hint.className = 'text-red-600';

                document.querySelectorAll('#fuzzyOptions button').forEach(btn => {
                    if (btn.dataset.meaning === answer) {
                        btn.classList.add('bg-red-500', 'text-white');
                    }
                    if (btn.dataset.meaning === currentQuestion.meaning) {
                        btn.classList.add('bg-green-500', 'text-white');
                    }
                    btn.disabled = true;
                    btn.classList.add('cursor-not-allowed');
                });

                updateStats();
                setTimeout(() => {
                    generateQuestion();
                }, 800);
            }
        }

        function checkPinyinMatch(userAnswer, correct) {
            if (userAnswer.toLowerCase() === correct.toLowerCase()) {
                return true;
            }

            const numberedPattern = /^([a-z]+)(\d)$/i;
            const userMatch = userAnswer.match(numberedPattern);

            if (userMatch) {
                const userBase = userMatch[1].toLowerCase();
                const userTone = userMatch[2];

                const toneMap = {
                    'ƒÅ': 'a1', '√°': 'a2', '«é': 'a3', '√†': 'a4',
                    'ƒì': 'e1', '√©': 'e2', 'ƒõ': 'e3', '√®': 'e4',
                    'ƒ´': 'i1', '√≠': 'i2', '«ê': 'i3', '√¨': 'i4',
                    '≈ç': 'o1', '√≥': 'o2', '«í': 'o3', '√≤': 'o4',
                    '≈´': 'u1', '√∫': 'u2', '«î': 'u3', '√π': 'u4',
                    '«ñ': 'u1', '«ò': 'u2', '«ö': 'u3', '«ú': 'u4'
                };

                let correctBase = correct;
                let correctTone = '';

                for (const [marked, numbered] of Object.entries(toneMap)) {
                    if (correct.includes(marked)) {
                        correctBase = correct.replace(marked, numbered[0]);
                        correctTone = numbered[1];
                        break;
                    }
                }

                return userBase === correctBase && userTone === correctTone;
            }

            return false;
        }

        function checkAnswer() {
            if (!answerInput.value.trim()) return;

            const userAnswer = answerInput.value.trim();

            if (mode === 'char-to-pinyin' || mode === 'audio-to-pinyin') {
                const pinyinOptions = currentQuestion.pinyin.split('/').map(p => p.trim());
                const correct = pinyinOptions.some(option => checkPinyinMatch(userAnswer, option));

                if (mode === 'char-to-pinyin') {
                    const firstPinyin = pinyinOptions[0];
                    const audioKey = pinyinToAudioKey(firstPinyin);
                    if (audioKey) {
                        const audioUrl = `https://www.purpleculture.net/mp3/${audioKey}.mp3`;
                        const audio = new Audio(audioUrl);
                        audio.play().catch(e => console.log('Audio play failed:', e));
                    }
                }

                if (correct) {
                    playCorrectSound();
                    if (!answered) {
                        answered = true;
                        total++;
                        score++;
                    }
                    if (mode === 'audio-to-pinyin') {
                        feedback.textContent = `‚úì Correct! ${currentQuestion.pinyin} (${currentQuestion.char})`;
                    } else {
                        feedback.textContent = `‚úì Correct! ${currentQuestion.char} = ${currentQuestion.pinyin}`;
                    }
                    feedback.className = 'text-green-600';
                    hint.textContent = `Meaning: ${currentQuestion.meaning}`;
                    hint.className = 'text-green-600';
                    setTimeout(() => {
                        generateQuestion();
                    }, 300);
                } else {
                    playWrongSound();
                    if (!answered) {
                        answered = true;
                        total++;
                    }
                    if (mode === 'audio-to-pinyin') {
                        feedback.textContent = `‚úó Wrong. The answer is: ${currentQuestion.pinyin} (${currentQuestion.char}). Try again!`;
                    } else {
                        feedback.textContent = `‚úó Wrong. The answer is: ${currentQuestion.pinyin}. Try again!`;
                    }
                    feedback.className = 'text-red-600';
                    hint.textContent = `Meaning: ${currentQuestion.meaning}`;
                    hint.className = 'text-red-600';
                    setTimeout(() => {
                        answerInput.value = '';
                        answerInput.focus();
                    }, 0);
                }

                updateStats();
            }
        }

        function checkMultipleChoice(answer) {
            if (answered) return;

            answered = true;
            total++;

            let correct = false;

            if (mode === 'char-to-pinyin-mc') {
                correct = answer === currentQuestion.pinyin;
            } else if (mode === 'char-to-meaning') {
                correct = answer === currentQuestion.meaning;
            } else if (mode === 'pinyin-to-char') {
                correct = answer === currentQuestion.char;
            } else if (mode === 'meaning-to-char') {
                correct = answer === currentQuestion.char;
            }

            if (correct) {
                playCorrectSound();
                score++;
                feedback.textContent = `‚úì Correct!`;
                feedback.className = 'text-green-600';
                hint.textContent = `${currentQuestion.char} (${currentQuestion.pinyin}) - ${currentQuestion.meaning}`;
                hint.className = 'text-green-600';

                document.querySelectorAll('#options button').forEach(btn => {
                    if (btn.textContent === answer) {
                        btn.classList.add('bg-green-500', 'text-white');
                    }
                    btn.disabled = true;
                    btn.classList.add('cursor-not-allowed');
                });

                updateStats();
                setTimeout(() => {
                    generateQuestion();
                }, 1000);
            } else {
                playWrongSound();
                feedback.textContent = `‚úó Wrong!`;
                feedback.className = 'text-red-600';
                hint.textContent = `${currentQuestion.char} (${currentQuestion.pinyin}) - ${currentQuestion.meaning}`;
                hint.className = 'text-red-600';

                document.querySelectorAll('#options button').forEach(btn => {
                    if (btn.textContent === answer) {
                        btn.classList.add('bg-red-500', 'text-white');
                    } else if (btn.textContent === currentQuestion.char) {
                        btn.classList.add('bg-green-500', 'text-white');
                    }
                    btn.disabled = true;
                    btn.classList.add('cursor-not-allowed');
                });

                updateStats();
                setTimeout(() => {
                    generateQuestion();
                }, 1500);
            }
        }

        function updateStats() {
            document.getElementById('score').textContent = score;
            document.getElementById('total').textContent = total;
            const accuracy = total === 0 ? 0 : Math.round((score / total) * 100);
            document.getElementById('accuracy').textContent = accuracy + '%';
        }

        checkBtn.addEventListener('click', checkAnswer);

        answerInput.addEventListener('keydown', (e) => {
            if (e.key === ' ' && mode === 'audio-to-pinyin') {
                e.preventDefault();
                if (window.currentAudioPlayFunc) {
                    window.currentAudioPlayFunc();
                }
            } else if (e.key === 'Enter') {
                e.preventDefault();
                checkAnswer();
            }
        });

        // Initialize
        generateQuestion();
    </script>
</body>
</html>
